<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evaluación Evacuación por Fachada - NTC 3833</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap');
        body { font-family: 'Roboto', sans-serif; background-color: #f3f4f6; }
        .input-field {
            transition: all 0.3s;
        }
        .input-field:focus {
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
        }
        /* Estilos específicos para impresión/PDF */
        #report-content {
            background: white;
            display: none; /* Oculto en vista normal */
        }
        .show-on-print { display: block !important; }
    </style>
</head>
<body class="text-gray-800">

    <!-- Navbar -->
    <nav class="bg-blue-800 text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <i class="fa-solid fa-calculator mr-3 text-xl"></i>
                    <span class="font-bold text-lg tracking-wider">CalcNTC 3833</span>
                </div>
                <div class="text-sm opacity-80 hidden sm:block">Método Anexo C - Evacuación Fachada</div>
            </div>
        </div>
    </nav>

    <div class="max-w-5xl mx-auto p-4 sm:p-6 lg:p-8">
        
        <!-- Header Info -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6 border-l-4 border-blue-600">
            <h1 class="text-2xl font-bold text-gray-800 mb-2">Evaluador de Condiciones de Instalación</h1>
            <p class="text-gray-600">Herramienta basada en el método alternativo (Anexo C) para valoración de particularidades del conector de evacuación directa a través de fachada.</p>
        </div>

        <form id="evalForm" onsubmit="event.preventDefault();">
            
            <!-- Grid Container -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

                <!-- Columna Izquierda: Datos y Geometría -->
                <div class="space-y-6">
                    
                    <!-- 1. Datos de Trazabilidad -->
                    <div class="bg-white rounded-lg shadow-md p-5">
                        <div class="flex items-center mb-4 text-blue-800">
                            <i class="fa-solid fa-clipboard-user mr-2"></i>
                            <h2 class="text-lg font-bold">1. Datos del Proyecto</h2>
                        </div>
                        <div class="grid grid-cols-1 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Cliente / Proyecto</label>
                                <input type="text" id="cliente" class="w-full border-gray-300 border rounded-md p-2 input-field" placeholder="Ej. Familia Pérez" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Dirección</label>
                                <input type="text" id="direccion" class="w-full border-gray-300 border rounded-md p-2 input-field" placeholder="Ej. Calle 123 # 45-67">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Técnico</label>
                                    <input type="text" id="tecnico" class="w-full border-gray-300 border rounded-md p-2 input-field" placeholder="Nombre">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Fecha</label>
                                    <input type="date" id="fecha" class="w-full border-gray-300 border rounded-md p-2 input-field">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 2. Condiciones Ambientales -->
                    <div class="bg-white rounded-lg shadow-md p-5">
                        <div class="flex items-center mb-4 text-blue-800">
                            <i class="fa-solid fa-cloud mr-2"></i>
                            <h2 class="text-lg font-bold">2. Factor de Corrección</h2>
                        </div>
                        <div class="bg-blue-50 p-3 rounded-md mb-3 text-sm text-blue-800">
                            <i class="fa-solid fa-circle-info mr-1"></i> Se calcula automáticamente según la presión local. El estándar base es 0.85 a nivel del mar.
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Presión Local (mbar)</label>
                                <input type="number" id="presion" value="752" class="w-full border-gray-300 border rounded-md p-2 input-field" oninput="calcular()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Factor Calculado</label>
                                <input type="text" id="factor" class="w-full bg-gray-100 border-gray-300 border rounded-md p-2 font-bold text-gray-600" readonly>
                            </div>
                        </div>
                    </div>

                    <!-- 3. Geometría (Ganancia) -->
                    <div class="bg-white rounded-lg shadow-md p-5 border-l-4 border-green-500">
                        <div class="flex items-center justify-between mb-4 text-green-700">
                            <div class="flex items-center">
                                <i class="fa-solid fa-arrow-up-from-bracket mr-2"></i>
                                <h2 class="text-lg font-bold">3. Ganancia de Cota (H)</h2>
                            </div>
                            <span class="text-xs font-semibold bg-green-100 px-2 py-1 rounded">Puntos Positivos</span>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Altura Vertical Total "H" (cm)</label>
                            <div class="flex items-center">
                                <input type="number" id="altura" value="33" min="0" step="1" class="w-full border-gray-300 border rounded-md p-2 input-field text-lg" oninput="calcular()">
                                <span class="ml-2 text-gray-500 font-bold">cm</span>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Medida desde el collarín hasta el deflector.</p>
                        </div>
                        <div class="mt-4 flex justify-between items-center bg-green-50 p-2 rounded">
                            <span class="text-sm font-medium">Puntos Ganados:</span>
                            <span id="puntosGanados" class="text-lg font-bold text-green-700">+0.00</span>
                        </div>
                    </div>

                </div>

                <!-- Columna Derecha: Resistencias y Resultados -->
                <div class="space-y-6">

                    <!-- 4. Componentes (Pérdidas) -->
                    <div class="bg-white rounded-lg shadow-md p-5 border-l-4 border-red-500">
                        <div class="flex items-center justify-between mb-4 text-red-700">
                            <div class="flex items-center">
                                <i class="fa-solid fa-road-barrier mr-2"></i>
                                <h2 class="text-lg font-bold">4. Resistencias (Pérdidas)</h2>
                            </div>
                            <span class="text-xs font-semibold bg-red-100 px-2 py-1 rounded">Puntos Negativos</span>
                        </div>
                        
                        <!-- Longitud -->
                        <div class="mb-4 pb-4 border-b border-gray-200">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Longitud Total Tramos Rectos (cm)</label>
                            <div class="flex items-center">
                                <input type="number" id="longitud" value="267" min="0" class="w-full border-gray-300 border rounded-md p-2 input-field" oninput="calcular()">
                                <span class="ml-2 text-gray-500">cm</span>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Suma de TRV + TRH (Ej. 22 + 245 = 267)</p>
                        </div>

                        <!-- Accesorios -->
                        <div class="space-y-3">
                            <div class="flex items-center justify-between">
                                <label class="flex items-center text-sm font-medium text-gray-700">
                                    <input type="checkbox" id="checkDeflector" checked class="mr-2 h-4 w-4 text-blue-600 rounded" onchange="calcular()">
                                    Deflector (Estándar -0.3)
                                </label>
                                <span class="text-sm text-red-600 font-mono">-0.3</span>
                            </div>
                            
                            <div class="grid grid-cols-3 gap-2 items-end">
                                <div class="col-span-1">
                                    <label class="text-xs text-gray-500 block">Cant. Codos 90°</label>
                                    <input type="number" id="codos90" value="1" min="0" class="w-full border p-1 rounded text-center" oninput="calcular()">
                                </div>
                                <div class="col-span-1">
                                    <label class="text-xs text-gray-500 block">Valor Unit.</label>
                                    <input type="number" id="valCodo90" value="2.0" step="0.1" class="w-full border p-1 rounded text-center bg-gray-50" readonly>
                                </div>
                                <div class="col-span-1 text-right text-red-600 font-mono text-sm py-2" id="totalCodos90">-2.00</div>
                            </div>

                            <div class="grid grid-cols-3 gap-2 items-end">
                                <div class="col-span-1">
                                    <label class="text-xs text-gray-500 block">Cant. Codos 45°</label>
                                    <input type="number" id="codos45" value="0" min="0" class="w-full border p-1 rounded text-center" oninput="calcular()">
                                </div>
                                <div class="col-span-1">
                                    <label class="text-xs text-gray-500 block">Valor Unit.</label>
                                    <input type="number" id="valCodo45" value="1.0" step="0.1" class="w-full border p-1 rounded text-center bg-gray-50" readonly>
                                </div>
                                <div class="col-span-1 text-right text-red-600 font-mono text-sm py-2" id="totalCodos45">-0.00</div>
                            </div>
                        </div>

                        <div class="mt-4 flex justify-between items-center bg-red-50 p-2 rounded">
                            <span class="text-sm font-medium">Puntos Perdidos:</span>
                            <span id="puntosPerdidos" class="text-lg font-bold text-red-700">-0.00</span>
                        </div>
                    </div>

                    <!-- 5. Resultado Final -->
                    <div class="bg-gray-800 text-white rounded-lg shadow-xl p-6 relative overflow-hidden">
                        <div class="relative z-10">
                            <h2 class="text-xl font-bold mb-4 border-b border-gray-600 pb-2">Resultado de Valoración</h2>
                            
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div>
                                    <div class="text-xs text-gray-400 uppercase">Puntos Globales</div>
                                    <div id="puntosGlobal" class="text-4xl font-bold">0.00</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-xs text-gray-400 uppercase">Estado</div>
                                    <div id="estadoTexto" class="text-2xl font-bold px-3 py-1 rounded inline-block mt-1">--</div>
                                </div>
                            </div>

                            <div class="text-sm mb-4">
                                <i class="fa-solid fa-scale-balanced mr-1"></i> Criterio: Se requiere un valor mínimo de <strong class="text-yellow-400">+1.00</strong> para aprobar.
                            </div>

                            <!-- Sugerencias -->
                            <div id="sugerenciasPanel" class="hidden bg-gray-700 rounded p-3 text-sm border border-gray-600">
                                <p class="text-yellow-300 font-bold mb-1"><i class="fa-solid fa-lightbulb mr-1"></i> Sugerencia de Corrección:</p>
                                <p>Para cumplir, debe aumentar la altura vertical (H) en aproximadamente <span id="hSugerida" class="font-bold text-white">0</span> cm adicionales.</p>
                                <p class="text-xs text-gray-400 mt-1">Nueva altura total recomendada: <span id="hTotalSugerida">0</span> cm.</p>
                            </div>
                        </div>
                        
                        <!-- Decorative background icon -->
                        <i class="fa-solid fa-check-double absolute -bottom-4 -right-4 text-9xl text-gray-700 opacity-20"></i>
                    </div>
                    
                    <button onclick="generarPDF()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow transition duration-200 flex justify-center items-center">
                        <i class="fa-solid fa-file-pdf mr-2"></i> Descargar Reporte PDF
                    </button>

                </div>
            </div>
        </form>
        
        <!-- Footer -->
        <div class="text-center mt-10 text-gray-500 text-xs">
            <p>Esta herramienta es un auxiliar de cálculo basado en el ejemplo del Anexo C de la NTC 3833.</p>
            <p>El instalador certificado es responsable de validar los datos en campo.</p>
        </div>

    </div>

    <!-- Template invisible para PDF -->
    <div id="report-content" class="p-8 max-w-2xl mx-auto">
        <div class="border-b-2 border-blue-800 pb-4 mb-6 flex justify-between items-end">
            <div>
                <h1 class="text-2xl font-bold text-gray-800">Reporte de Evaluación</h1>
                <p class="text-sm text-gray-600">Instalación Calentador de Paso - Evacuación Fachada</p>
                <p class="text-xs text-gray-500">Ref: NTC 3833 Anexo C</p>
            </div>
            <div class="text-right">
                <div class="text-3xl font-bold text-gray-300">LOGO</div>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-6 text-sm">
            <div><strong>Cliente:</strong> <span id="pdf-cliente"></span></div>
            <div><strong>Fecha:</strong> <span id="pdf-fecha"></span></div>
            <div><strong>Dirección:</strong> <span id="pdf-direccion"></span></div>
            <div><strong>Técnico:</strong> <span id="pdf-tecnico"></span></div>
        </div>

        <table class="w-full text-sm border-collapse border border-gray-300 mb-6">
            <thead class="bg-gray-100">
                <tr>
                    <th class="border p-2 text-left">Parámetro</th>
                    <th class="border p-2 text-right">Valor</th>
                    <th class="border p-2 text-right">Puntos</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td class="border p-2 font-bold" colspan="3">Condiciones</td>
                </tr>
                <tr>
                    <td class="border p-2">Presión Atmosférica</td>
                    <td class="border p-2 text-right"><span id="pdf-presion"></span> mbar</td>
                    <td class="border p-2 text-right text-gray-500">Factor: <span id="pdf-factor"></span></td>
                </tr>
                <tr>
                    <td class="border p-2 font-bold text-green-700" colspan="3">Ganancias (+)</td>
                </tr>
                <tr>
                    <td class="border p-2">Altura Vertical (H)</td>
                    <td class="border p-2 text-right"><span id="pdf-altura"></span> cm</td>
                    <td class="border p-2 text-right font-bold text-green-700" id="pdf-pts-ganados"></td>
                </tr>
                <tr>
                    <td class="border p-2 font-bold text-red-700" colspan="3">Pérdidas (-)</td>
                </tr>
                <tr>
                    <td class="border p-2">Longitud Tramos Rectos</td>
                    <td class="border p-2 text-right"><span id="pdf-longitud"></span> cm</td>
                    <td class="border p-2 text-right text-red-700" id="pdf-pts-longitud"></td>
                </tr>
                <tr>
                    <td class="border p-2">Deflector</td>
                    <td class="border p-2 text-right" id="pdf-deflector-status"></td>
                    <td class="border p-2 text-right text-red-700" id="pdf-pts-deflector"></td>
                </tr>
                <tr>
                    <td class="border p-2">Codos</td>
                    <td class="border p-2 text-right" id="pdf-codos-desc"></td>
                    <td class="border p-2 text-right text-red-700" id="pdf-pts-codos"></td>
                </tr>
            </tbody>
            <tfoot class="bg-gray-50 font-bold">
                <tr>
                    <td class="border p-3 text-right" colspan="2">TOTAL PUNTOS</td>
                    <td class="border p-3 text-right text-lg" id="pdf-total"></td>
                </tr>
                <tr>
                    <td class="border p-3 text-right" colspan="2">RESULTADO</td>
                    <td class="border p-3 text-right text-white" id="pdf-resultado"></td>
                </tr>
            </tfoot>
        </table>

        <div class="mt-8 pt-4 border-t border-gray-300">
            <p class="text-xs text-center text-gray-500">Firma del Técnico</p>
            <div class="h-16 border-b border-gray-400 w-1/2 mx-auto mb-2"></div>
        </div>
    </div>

    <script>
        // Inicialización de fecha
        document.getElementById('fecha').valueAsDate = new Date();

        function calcular() {
            // 1. Obtener Valores
            const presion = parseFloat(document.getElementById('presion').value) || 0;
            const altura = parseFloat(document.getElementById('altura').value) || 0;
            const longitud = parseFloat(document.getElementById('longitud').value) || 0;
            
            const tieneDeflector = document.getElementById('checkDeflector').checked;
            const cantCodos90 = parseFloat(document.getElementById('codos90').value) || 0;
            const valCodo90 = parseFloat(document.getElementById('valCodo90').value) || 2.0;
            const cantCodos45 = parseFloat(document.getElementById('codos45').value) || 0;
            const valCodo45 = parseFloat(document.getElementById('valCodo45').value) || 1.0;

            // 2. Cálculo del Factor
            // Fórmula basada en el ejemplo: 0.85 * (PresionLocal / 1013.25)
            // Ejemplo PDF: 0.85 * (752 / 1013.25) = 0.63 -> Redondeado a 0.6 en el ejemplo del usuario.
            // Usaremos 2 decimales para mayor precisión similar al ejemplo o el cálculo exacto.
            let factorCalculado = 0.85 * (presion / 1013.25);
            // Ajuste fino para coincidir con el ejemplo si es 752 (para propósitos pedagógicos del usuario)
            // Pero para una herramienta real, la precisión es mejor.
            // Mostramos 3 decimales
            document.getElementById('factor').value = factorCalculado.toFixed(3);

            // 3. Puntos Positivos (Ganancia de Cota)
            // El ejemplo dice: Puntos = (H_cm / 10) * Factor
            const ptsGanados = (altura / 10) * factorCalculado;
            document.getElementById('puntosGanados').innerText = `+${ptsGanados.toFixed(2)}`;

            // 4. Puntos Negativos (Pérdidas)
            
            // Deflector
            const ptsDeflector = tieneDeflector ? 0.3 : 0;
            
            // Tramos rectos: Ejemplo dice (-0.5 puntos / cada 100 cm)
            // Fórmula: (Longitud / 100) * 0.5
            const ptsLongitud = (longitud / 100) * 0.5;

            // Codos
            const ptsCodos90 = cantCodos90 * valCodo90;
            const ptsCodos45 = cantCodos45 * valCodo45;
            
            document.getElementById('totalCodos90').innerText = `-${ptsCodos90.toFixed(2)}`;
            document.getElementById('totalCodos45').innerText = `-${ptsCodos45.toFixed(2)}`;

            const totalPerdidos = ptsDeflector + ptsLongitud + ptsCodos90 + ptsCodos45;
            document.getElementById('puntosPerdidos').innerText = `-${totalPerdidos.toFixed(2)}`;

            // 5. Total Global
            const totalGlobal = ptsGanados - totalPerdidos;
            const divGlobal = document.getElementById('puntosGlobal');
            divGlobal.innerText = totalGlobal.toFixed(2);
            divGlobal.className = totalGlobal >= 1.0 ? 'text-4xl font-bold text-green-400' : 'text-4xl font-bold text-red-400';

            // 6. Estado y Sugerencias
            const estadoDiv = document.getElementById('estadoTexto');
            const sugerenciasPanel = document.getElementById('sugerenciasPanel');

            if (totalGlobal >= 1.0) {
                estadoDiv.innerText = "CUMPLE";
                estadoDiv.className = "text-2xl font-bold px-3 py-1 rounded inline-block mt-1 bg-green-600 text-white";
                sugerenciasPanel.classList.add('hidden');
            } else {
                estadoDiv.innerText = "NO CUMPLE";
                estadoDiv.className = "text-2xl font-bold px-3 py-1 rounded inline-block mt-1 bg-red-600 text-white";
                
                // Cálculo de Sugerencia (Alternativa 1 del PDF)
                // Objetivo: Llegar a 1.0
                // (NuevaAltura / 10 * Factor) - Perdidas = 1.0
                // NuevaAltura = (1.0 + Perdidas) / Factor * 10
                const perdidasActuales = totalPerdidos;
                const alturaNecesaria = ((1.0 + perdidasActuales) / factorCalculado) * 10;
                const alturaAdicional = alturaNecesaria - altura;

                if (alturaAdicional > 0 && factorCalculado > 0) {
                    sugerenciasPanel.classList.remove('hidden');
                    document.getElementById('hSugerida').innerText = Math.ceil(alturaAdicional);
                    document.getElementById('hTotalSugerida').innerText = Math.ceil(alturaNecesaria);
                }
            }

            return {
                presion, factorCalculado, altura, ptsGanados, longitud, ptsLongitud, 
                tieneDeflector, ptsDeflector, cantCodos90, ptsCodos90, cantCodos45, ptsCodos45, 
                totalPerdidos, totalGlobal
            };
        }

        function generarPDF() {
            const data = calcular();
            const cliente = document.getElementById('cliente').value || "Cliente General";
            const fecha = document.getElementById('fecha').value;
            const direccion = document.getElementById('direccion').value;
            const tecnico = document.getElementById('tecnico').value;

            // Llenar datos en el template oculto
            document.getElementById('pdf-cliente').innerText = cliente;
            document.getElementById('pdf-fecha').innerText = fecha;
            document.getElementById('pdf-direccion').innerText = direccion;
            document.getElementById('pdf-tecnico').innerText = tecnico;

            document.getElementById('pdf-presion').innerText = data.presion;
            document.getElementById('pdf-factor').innerText = data.factorCalculado.toFixed(3);
            
            document.getElementById('pdf-altura').innerText = data.altura;
            document.getElementById('pdf-pts-ganados').innerText = `+${data.ptsGanados.toFixed(2)}`;
            
            document.getElementById('pdf-longitud').innerText = data.longitud;
            document.getElementById('pdf-pts-longitud').innerText = `-${data.ptsLongitud.toFixed(2)}`;
            
            document.getElementById('pdf-deflector-status').innerText = data.tieneDeflector ? "Si" : "No";
            document.getElementById('pdf-pts-deflector').innerText = `-${data.ptsDeflector.toFixed(2)}`;
            
            document.getElementById('pdf-codos-desc').innerText = `90° (${data.cantCodos90}) | 45° (${data.cantCodos45})`;
            document.getElementById('pdf-pts-codos').innerText = `-${(data.ptsCodos90 + data.ptsCodos45).toFixed(2)}`;
            
            document.getElementById('pdf-total').innerText = data.totalGlobal.toFixed(2);
            
            const resultadoEl = document.getElementById('pdf-resultado');
            if (data.totalGlobal >= 1.0) {
                resultadoEl.innerText = "CUMPLE (APROBADO)";
                resultadoEl.className = "border p-3 text-right bg-green-600 text-white";
            } else {
                resultadoEl.innerText = "NO CUMPLE (RECHAZADO)";
                resultadoEl.className = "border p-3 text-right bg-red-600 text-white";
            }

            // Configurar opciones de PDF
            const element = document.getElementById('report-content');
            element.style.display = 'block'; // Mostrar temporalmente para renderizar

            const opt = {
                margin:       10,
                filename:     `Evaluacion_NTC3833_${cliente.replace(/\s+/g, '_')}.pdf`,
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2 },
                jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(element).save().then(() => {
                element.style.display = 'none'; // Ocultar de nuevo
            });
        }

        // Calcular al cargar para mostrar valores iniciales
        window.onload = calcular;
    </script>
</body>
</html>