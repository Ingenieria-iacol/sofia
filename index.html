<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SofI.A. | Git de Ingeniería</title>
    <!-- Iconos FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Fuente Roboto -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* --- VARIABLES DE DISEÑO (FUSIÓN) --- */
        :root {
            --primary-brand: #0071eb; /* Azul SofI.A. */
            --bg-black: #141414;
            --bg-dark-gray: #181818;
            --text-white: #ffffff;
            --text-gray: #e5e5e5;
            --text-dark: #b3b3b3;
            --success-green: #46d369;
            
            /* Colores de Perfil */
            --corp-color: #3b82f6;
            --edu-color: #f59e0b; 
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Roboto', 'Helvetica Neue', Helvetica, Arial, sans-serif; }

        body {
            background-color: var(--bg-black);
            color: var(--text-white);
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* --- UTILIDADES --- */
        .hidden { display: none !important; }
        .btn { 
            cursor: pointer; border: none; outline: none; font-weight: bold; border-radius: 4px; 
            transition: transform 0.2s, background 0.2s; text-transform: uppercase;
        }
        .btn:hover { transform: scale(1.05); }
        a { text-decoration: none; color: inherit; cursor: pointer; }

        /* --- PANTALLA DE LOGIN --- */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, rgba(0, 113, 235, 0.2) 0%, rgba(0,0,0,0.9) 100%), 
                        url('https://images.unsplash.com/photo-1620712943543-bcc4688e7485?q=80&w=2000&auto=format&fit=crop');
            background-size: cover; background-position: center;
            display: flex; justify-content: center; align-items: center; z-index: 3000;
            transition: opacity 0.8s ease;
        }

        .login-box-static {
            background-color: rgba(0, 0, 0, 0.85); padding: 60px 50px; border-radius: 8px; 
            width: 100%; max-width: 450px; text-align: center;
            box-shadow: 0 0 50px rgba(0,0,0,0.8); border: 1px solid rgba(255,255,255,0.1);
            display: flex; flex-direction: column; backdrop-filter: blur(10px);
        }
        
        .login-title { color: var(--primary-brand); font-size: 3rem; font-weight: 900; margin-bottom: 5px; letter-spacing: -1px; }
        .login-subtitle { color: var(--text-dark); font-size: 0.9rem; letter-spacing: 2px; margin-bottom: 30px; text-transform: uppercase; }
        
        .login-input { 
            width: 100%; padding: 16px; background: #333; border: 1px solid transparent; 
            border-radius: 4px; color: white; font-size: 1rem; margin-bottom: 20px; transition: 0.3s;
        }
        .login-input:focus { outline: none; background: #444; border-bottom: 2px solid var(--primary-brand); }
        
        .password-wrapper { position: relative; margin-bottom: 20px; }
        .password-wrapper input { margin-bottom: 0; }
        .toggle-password { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #888; cursor: pointer; }
        
        .login-btn-primary { width: 100%; padding: 16px; background: var(--primary-brand); color: white; margin-bottom: 15px; font-size: 1rem; }
        .login-btn-secondary { width: 100%; padding: 14px; background: transparent; border: 1px solid #555; color: #aaa; font-size: 0.9rem; }
        .login-btn-secondary:hover { border-color: white; color: white; }
        .login-error { color: #e50914; margin-top: 15px; font-size: 0.9rem; display: none; }
        
        /* --- PROFILE GATE ("Quién está viendo") --- */
        #profile-gate {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #141414; z-index: 2500;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            animation: fadeIn 0.5s ease;
        }
        
        .gate-title { font-size: 3.5rem; font-weight: 300; margin-bottom: 2rem; color: white; text-align: center; }
        .gate-container { display: flex; gap: 2rem; flex-wrap: wrap; justify-content: center; }
        
        .profile-card { 
            display: flex; flex-direction: column; align-items: center; cursor: pointer; 
            transition: transform 0.2s; width: 150px; opacity: 0.6; 
        }
        .profile-card:hover { transform: scale(1.05); opacity: 1; }
        
        .profile-avatar-big {
            width: 150px; height: 150px; border-radius: 4px; margin-bottom: 1rem;
            background-color: #333; display: flex; justify-content: center; align-items: center;
            font-size: 5rem; border: 3px solid transparent; background-size: cover; background-position: center;
        }
        .profile-card:hover .profile-avatar-big { border-color: white; }
        .profile-name { font-size: 1.2rem; color: gray; font-weight: 400; }
        .profile-card:hover .profile-name { color: white; }

        /* Estilos de Avatar */
        .av-gen { background: linear-gradient(135deg, #333, #666); color: white; }
        .av-corp { background: linear-gradient(135deg, #1e3a8a, var(--corp-color)); color: white; }
        .av-edu { background: linear-gradient(135deg, #78350f, var(--edu-color)); color: white; }

        /* --- NAVBAR --- */
        .navbar {
            position: fixed; top: 0; width: 100%; padding: 15px 4%;
            display: flex; justify-content: space-between; align-items: center;
            background: linear-gradient(to bottom, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0) 100%);
            z-index: 1000; transition: background-color 0.3s;
        }
        .navbar.scrolled { background-color: var(--bg-black); }
        
        .nav-logo { color: var(--primary-brand); font-size: 1.8rem; font-weight: bold; margin-right: 40px; text-transform: uppercase; letter-spacing: 1px; }
        .nav-links { display: flex; gap: 20px; font-size: 0.9rem; }
        .nav-item { color: var(--text-gray); transition: 0.3s; }
        .nav-item:hover, .nav-item.active { color: white; font-weight: bold; }
        
        .user-menu { display: flex; align-items: center; gap: 20px; }
        
        /* Buscador Desplegable */
        .search-box { 
            display: flex; align-items: center; background: transparent; border: 1px solid transparent;
            padding: 5px; transition: all 0.3s; width: 30px; overflow: hidden;
        }
        .search-box.active { background: black; border: 1px solid white; width: 250px; }
        .search-input { background: transparent; border: none; color: white; outline: none; width: 100%; margin-left: 10px; opacity: 0; }
        .search-box.active .search-input { opacity: 1; }

        .profile-badge { border: 1px solid white; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; }
        
        .nav-avatar-small { 
            width: 32px; height: 32px; border-radius: 4px; cursor: pointer; background: #333;
            display: flex; align-items: center; justify-content: center; background-size: cover; background-position: center;
        }

        /* --- INTERFAZ PRINCIPAL (DASHBOARD) --- */
        #main-interface { padding-bottom: 50px; }

        /* Hero Section */
        .hero {
            height: 85vh; width: 100%; position: relative;
            background: linear-gradient(rgba(0,0,0,0), var(--bg-black)), 
                        url('https://images.unsplash.com/photo-1626814026160-2237a95fc5a0?q=80&w=2070&auto=format&fit=crop') no-repeat center center/cover;
            background-size: cover; background-position: center;
            display: flex; align-items: center; padding-left: 4%;
            transition: background-image 0.8s ease-in-out;
        }
        
        .hero-content { max-width: 650px; z-index: 10; padding-top: 60px; transition: opacity 0.5s; }
        .hero-content.fade-out { opacity: 0; }
        
        .hero-title { font-size: 4rem; font-weight: 800; margin-bottom: 15px; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); line-height: 1; }
        .hero-desc { font-size: 1.2rem; margin-bottom: 25px; color: #fff; text-shadow: 1px 1px 2px rgba(0,0,0,0.8); line-height: 1.5; font-weight: 400; }
        
        .hero-btns { display: flex; gap: 15px; }
        .hero-btn { padding: 10px 25px; font-size: 1.2rem; display: flex; align-items: center; gap: 10px; border-radius: 4px; }
        .btn-white { background: white; color: black; }
        .btn-gray { background: rgba(109,109,110,0.7); color: white; }
        .btn-gray:hover { background: rgba(109,109,110,0.4); }

        /* Carruseles / Filas */
        .content-rows { position: relative; z-index: 20; margin-top: -100px; }
        .row { margin-bottom: 3rem; padding-left: 4%; }
        .row-title { font-size: 1.4rem; font-weight: 600; color: #e5e5e5; margin-bottom: 1rem; }
        
        .row-slider { 
            display: flex; gap: 10px; overflow-x: auto; padding: 20px 0; 
            scrollbar-width: none; /* Firefox */
        }
        .row-slider::-webkit-scrollbar { display: none; } /* Chrome */

        /* Tarjetas (Tiles) */
        .tile {
            min-width: 250px; height: 140px; background: #222; border-radius: 4px;
            position: relative; cursor: pointer; transition: transform 0.3s, z-index 0s; flex-shrink: 0;
        }
        .tile:hover { transform: scale(1.4); z-index: 100; box-shadow: 0 0 20px rgba(0,0,0,0.7); border-radius: 6px; }
        
        .tile-img { width: 100%; height: 100%; object-fit: cover; border-radius: 4px; transition: opacity 0.3s; }
        .tile:hover .tile-img { opacity: 0.3; }
        
        .tile-info {
            position: absolute; inset: 0; background: #181818; opacity: 0;
            display: flex; flex-direction: column; justify-content: center; padding: 10px;
            transition: opacity 0.3s; border-radius: 6px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.9); text-align: center; align-items: center;
        }
        .tile:hover .tile-info { opacity: 1; }

        .tile-actions { display: flex; gap: 10px; margin-bottom: 10px; }
        .action-btn { 
            width: 30px; height: 30px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.5); 
            display: flex; align-items: center; justify-content: center; font-size: 0.8rem; 
            background: rgba(40,40,40,0.8); color: white; transition: 0.2s; 
        }
        .action-btn:hover { background: white; color: black; border-color: white; }
        
        .tile-name { font-size: 0.9rem; font-weight: bold; margin-bottom: 5px; color: white; }
        /* Subtítulo visible en hover */
        .tile-subtitle { font-size: 0.7rem; color: #ccc; margin-bottom: 8px; line-height: 1.2; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .tile-meta { font-size: 0.7rem; color: var(--success-green); font-weight: bold; }

        .search-results-grid { display: flex; flex-wrap: wrap; gap: 20px; padding-left: 4%; padding-right: 4%; }

        /* --- MODALES (Edición, Login Secundario, Info) --- */
        .modal-overlay {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 5000;
            justify-content: center; align-items: center; backdrop-filter: blur(5px);
            animation: fadeIn 0.3s;
        }
        .modal-box {
            background: #181818; padding: 40px; border-radius: 8px; width: 90%; max-width: 500px;
            position: relative; box-shadow: 0 20px 50px rgba(0,0,0,0.8);
        }
        .close-modal { position: absolute; top: 15px; right: 20px; background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; }

        /* Inputs en modales */
        .modal-input { 
            width: 100%; padding: 12px; background: #333; border: 1px solid #444; 
            border-radius: 4px; color: white; margin-bottom: 15px; 
        }
        
        /* Visor de Apps */
        #viewer { display: none; position: fixed; inset: 0; background: black; z-index: 6000; flex-direction: column; }
        iframe { width: 100%; height: 100%; border: none; background: white; }

        @keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} }

        footer { margin-top: 80px; text-align: center; color: #555; font-size: 0.9rem; padding: 20px; border-top: 1px solid #222; }
    </style>
</head>
<body>

    <!-- Audio de Fondo Persistente -->
    <audio id="bg-music" loop><source src="" type="audio/mpeg"></audio>

    <!-- 1. LOGIN SCREEN -->
    <div id="login-screen">
        <div class="login-box-static">
            <h1 class="login-title">Git De Ingeniería</h1>
            <div class="login-subtitle">Credenciales De Acceso</div>
            
            <form onsubmit="intentarLogin(event, 'General')">
                <input type="text" id="user-static" class="login-input" placeholder="Usuario" required>
                <div class="password-wrapper">
                    <input type="password" id="pass-static" class="login-input" placeholder="Contraseña" style="margin-bottom:0;" required>
                    <i class="fas fa-eye toggle-password" onclick="togglePass('pass-static')"></i>
                </div>
                <br>
                <button type="submit" class="btn login-btn-primary">INICIAR SESIÓN</button>
                <button type="button" class="btn login-btn-secondary" onclick="mostrarVideo()">
                    <i class="fas fa-play-circle"></i> SABER MÁS
                </button>
                <p id="error-static" class="login-error">Credenciales incorrectas.</p>
            </form>
            <div style="margin-top:30px; padding-top:15px; border-top:1px solid #333; color:#666; font-size:0.8rem;">
                &copy; 2025 SofI.A. Engineering Git - Desarrollado para el futuro.
            </div>
        </div>
    </div>

    <!-- 2. PROFILE GATE (SELECTOR) -->
    <div id="profile-gate" class="hidden">
        <h1 class="gate-title">¿Quién está viendo ahora?</h1>
        <div class="gate-container">
            <div class="profile-card" onclick="seleccionarPerfil('General')">
                <div class="profile-avatar-big av-gen"><i class="fas fa-tools"></i></div>
                <span class="profile-name">General</span>
            </div>
            <div class="profile-card" onclick="seleccionarPerfil('Corporativo')">
                <div class="profile-avatar-big av-corp"><i class="fas fa-building"></i></div>
                <span class="profile-name">Corporativo</span>
            </div>
            <div class="profile-card" onclick="seleccionarPerfil('Académico')">
                <div class="profile-avatar-big av-edu"><i class="fas fa-graduation-cap"></i></div>
                <span class="profile-name">Académico</span>
            </div>
        </div>
        <button class="btn" style="margin-top:50px; background:transparent; border:1px solid gray; color:gray; padding:10px 30px;" onclick="cerrarSesion()">SALIR</button>
    </div>

    <!-- 3. INTERFAZ PRINCIPAL -->
    <div id="main-interface" class="hidden">
        <nav id="navbar" class="navbar">
            <div style="display:flex; align-items:center;">
                <div class="nav-logo" onclick="location.reload()">Git De Ingenieria</div>
                <div class="nav-links">
                    <a href="interfazDeOpcionInicio.html" class="nav-item">Inicio</a>
                    <a href="#" class="nav-item active" onclick="location.reload()">Herramientas</a>
                    <span class="nav-item">Mi Lista</span>
                </div>
            </div>
            <div class="user-menu">
                <div class="search-box" id="search-box">
                    <i class="fas fa-search" onclick="toggleSearch()" style="cursor:pointer; color:#ccc;"></i>
                    <input type="text" id="search-input" class="search-input" placeholder="Buscar herramientas..." oninput="filtrar(this.value)">
                </div>
                <span id="profile-indicator" class="profile-badge">GENERAL</span>
                <div id="nav-avatar-icon" class="nav-avatar-small av-gen" onclick="abrirEditor()" title="Editar Perfil">
                    <i class="fas fa-user"></i>
                </div>
                <i class="fas fa-sign-out-alt" style="cursor:pointer; color:#ccc;" onclick="abrirGate()"></i>
            </div>
        </nav>

        <div class="hero" id="hero-bg">
            <div class="hero-content">
                <div style="background:rgba(0,0,0,0.4); padding:20px; border-radius:8px; backdrop-filter:blur(5px);">
                    <h1 class="hero-title" id="hero-title">TITULO</h1>
                    <p class="hero-desc" id="hero-desc">Descripción</p>
                    <div class="hero-btns">
                        <button class="btn btn-white" id="hero-play"><i class="fas fa-play"></i> Abrir</button>
                        <button class="btn btn-gray" id="hero-info"><i class="fas fa-info-circle"></i> Info</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="content-rows" id="rows-container"></div>

        <footer>
            <div style="margin-bottom:20px; font-size:1.5rem;"><i class="fab fa-facebook-f" style="margin:0 15px;"></i> <i class="fab fa-instagram" style="margin:0 15px;"></i></div>
            <p>&copy; 2025 SofI.A. Engineering Git - Desarrollado para el futuro.</p>
        </footer>
    </div>

    <!-- MODALES -->
    
    <!-- Login Secundario -->
    <div id="modal-login-sec" class="modal-overlay">
        <div class="modal-box" style="border-top:4px solid var(--primary-brand);">
            <button class="close-modal" onclick="cerrarModal('modal-login-sec')">&times;</button>
            <h2 style="margin-bottom:10px;">Perfil <span id="sec-profile-name"></span></h2>
            <p style="color:#aaa; margin-bottom:20px;">Verifique sus credenciales</p>
            <form onsubmit="intentarLogin(event, 'Dynamic')">
                <input type="text" id="user-dyn" class="modal-input" placeholder="Usuario" required>
                <input type="password" id="pass-dyn" class="modal-input" placeholder="Contraseña" required>
                <button type="submit" class="btn login-btn-primary">ACCEDER</button>
                <p id="error-dyn" class="login-error">Datos incorrectos</p>
            </form>
        </div>
    </div>

    <!-- Editor Perfil -->
    <div id="modal-editor" class="modal-overlay" style="overflow-y:auto;">
        <div class="modal-box">
            <button class="close-modal" onclick="cerrarModal('modal-editor')">&times;</button>
            <h2 style="text-align:center; margin-bottom:20px;">Perfil Profesional</h2>
            
            <label for="avatar-upload" style="display:block; width:100px; margin:0 auto 20px;">
                <div id="preview-avatar" style="width:100px; height:100px; border-radius:50%; background:#333; display:flex; justify-content:center; align-items:center; border:2px solid #555; cursor:pointer; background-size:cover;">
                    <i class="fas fa-camera" style="font-size:2rem; color:#666;"></i>
                </div>
            </label>
            <input type="file" id="avatar-upload" accept="image/*" style="display:none;" onchange="previewImg(event)">

            <div style="display:flex; gap:10px;">
                <input type="text" id="edit-email" class="modal-input" readonly style="background:#222; color:#666;">
                <input type="password" id="edit-pass" class="modal-input" readonly style="background:#222; color:#666;">
            </div>
            <div style="display:flex; gap:10px;">
                <input type="text" id="edit-name" class="modal-input" placeholder="Nombre">
                <input type="text" id="edit-lastname" class="modal-input" placeholder="Apellido">
            </div>
            <div style="display:flex; gap:10px;">
                <input type="tel" id="edit-phone" class="modal-input" placeholder="Teléfono">
                <input type="text" id="edit-location" class="modal-input" placeholder="Ubicación">
            </div>
            <select id="edit-profession" class="modal-input">
                <option value="">Profesión...</option><option>Ingeniero</option><option>Arquitecto</option><option>Tecnólogo</option><option>Técnico</option><option>Estudiante</option>
            </select>
            <select id="edit-area" class="modal-input" onchange="toggleConsultorArea()">
                <option value="">Área...</option><option value="Electricidad">Electricidad</option><option value="Gas">Gas</option><option value="Agua">Agua</option><option value="Consultor">Consultor</option>
            </select>
            <div id="consultant-area-group" class="hidden" style="margin-bottom:15px; border-left:3px solid var(--secondary-green); padding-left:10px;">
                <label style="color:var(--secondary-green); font-size:0.8rem;">Especifique Área</label>
                <select id="edit-consultant-area" class="modal-input">
                     <option value="">Seleccione...</option><option>Electricidad</option><option>Gas</option><option>Agua</option>
                </select>
            </div>
            <button class="btn login-btn-primary" onclick="guardarPerfil()">GUARDAR CAMBIOS</button>
        </div>
    </div>

    <!-- Info Detalles -->
    <div id="modal-details" class="modal-overlay">
        <div class="modal-box" style="max-width:700px; padding:0; overflow:hidden;">
            <div id="detail-banner" style="height:300px; background-size:cover; position:relative;">
                <button class="close-modal" onclick="cerrarModal('modal-details')" style="background:rgba(0,0,0,0.5); border-radius:50%; width:40px; height:40px;">&times;</button>
                <div style="position:absolute; bottom:0; width:100%; background:linear-gradient(transparent, #181818); height:100px;"></div>
            </div>
            <div style="padding:30px;">
                <h1 id="detail-title">Titulo</h1>
                <div style="display:flex; gap:15px; margin:10px 0; font-weight:bold;">
                    <span style="color:var(--success-green)">98% Coincidencia</span>
                    <span id="detail-cat" style="background:#333; padding:2px 8px; border-radius:4px; font-size:0.8rem;"></span>
                </div>
                <!-- DETALLES RESTAURADOS -->
                <p id="detail-desc" style="color:#ccc; line-height:1.5; margin-bottom:20px; font-size:1.1rem;"></p>
                
                <button class="btn login-btn-primary" id="detail-open"><i class="fas fa-play"></i> ABRIR HERRAMIENTA</button>
            </div>
        </div>
    </div>

    <!-- Visor App -->
    <div id="viewer">
        <div style="padding:10px 20px; background:#111; display:flex; justify-content:space-between; align-items:center;">
            <span style="font-weight:bold; color:var(--primary-brand);">App Viewer</span>
            <button class="btn" style="background:transparent; border:1px solid #555; color:white; padding:5px 15px;" onclick="document.getElementById('viewer').style.display='none'">CERRAR</button>
        </div>
        <iframe id="app-frame" src=""></iframe>
    </div>
    
    <!-- Video -->
    <div id="video-modal" class="modal-overlay" onclick="this.style.display='none'; document.getElementById('promo-video').pause();">
        <button class="close-modal" style="top:30px; right:30px; font-size:2.5rem;">&times;</button>
        <video id="promo-video" controls src="VideoSaberMas.mp4" style="width:80%; max-width:900px; border-radius:8px;"></video>
    </div>

    <script>
        // --- DATOS ---
        const DEFAULT_USERS = [
            { u: "josetangarife14@gmail.com", p: "14568734", n: "Jose", a: "Tangarife", img: "" },
            { u: "julianvalencia@inse.net.co", p: "1211", n: "Julian", a: "Valencia", img: "" },
            { u: "alexander221977@gmail.com", p: "2505", n: "Alexander", a: "", img: "" }
        ];
        
        const TOOLS = [
            { id: 1, nombre: "Calculadora de ventilación", url: "Calculadora de ventilacion 3631 V_Libre.html", imagen: "Imagen001.png", descripcion: "Determina la capacidad de ventilación de un recinto ingresando solo las dimensiones espaciales y la potencia instalada.", categoria: "Ventilación", subtitulo: "Optimización de flujo de aire" },
            { id: 2, nombre: "Convertidor GLP", url: "Aplicacion Convertidor Universal GLP", imagen: "Imagen004convertidorGLP.png", descripcion: "Herramienta esencial para conversiones másicas precisas: de Kg a m3, de Galones a Kg, y otras unidades fundamentales.", categoria: "Utilidades", subtitulo: "Conversión másica precisa" },
            { id: 3, nombre: "EnginnerIA", url: "Chat Bot", imagen: "LogoIngenieroIA.png", descripcion: "Chatea con la I.A. experta sobre temas relacionados con las redes de gas y sistemas de combustión.", categoria: "Inteligencia Artificial", subtitulo: "Asistente Virtual Experto" },
            { id: 4, nombre: "Diseño Media Presión", url: "Modelador Mueller V_Pro (1211)", imagen: "Imagen003DiseñoMueller.png", descripcion: "Algoritmo Mueller: Estima las pérdidas de presión y calcula la velocidad en sistemas > 0,33 psi.", categoria: "Diseño", subtitulo: "Modelo Mueller (> 0.33 psi)" },
            { id: 5, nombre: "Diseño Baja Presión", url: "Modelador Renoaurd-V_Pro", imagen: "Imagen002DiseñoRenouard.png", descripcion: "Algoritmo Renouard: Estima las pérdidas de presión en sistemas que operan a presiones <= 0,33 psi.", categoria: "Diseño", subtitulo: "Modelo Renouard (<= 0.33 psi)" },
            { id: 6, nombre: "Inspector De Ventilacion", url: "Calculadora de ventilacion 3631 V_Pro.html", imagen: "ImagenAppInspectorVentil.png", descripcion: "Evalua la capacidad de ventilacion de un recinto en relacion a la NTC 3631 2da. Act.", categoria: "Ventilación", subtitulo: "Auditoría NTC 3631" },
            { id: 7, nombre: "Inspector De Vacios Internos", url: "./inventario.html", imagen: "SinContenido.png", descripcion: "Evalua y califica un vacio interno de acuerdo con la NTC 3631 2da. Act.", categoria: "Próximamente", subtitulo: "Normativa de espacios confinados" },
            { id: 8, nombre: "Seleccion de reguladores", url: "./inventario.html", imagen: "ImagenReguladores.png", descripcion: "Ingresa la presion de entrada, elije la salida y precisa el consumo.", categoria: "Próximamente", subtitulo: "Selección automática de equipos" },
            { id: 9, nombre: "Gestor Normativo", url: "./inventario.html", imagen: "ImagenGestorNormativo.png", descripcion: "Repositorio de documentos de ingenieria, normas y marco regulatorio.", categoria: "Próximamente", subtitulo: "Biblioteca Legal Técnica" },
            { id: 10, nombre: "Instalacion tanques GLP", url: "./inventario.html", imagen: "Imagendistanciamientodetanque.png", descripcion: "Normas tecnicas y distancias de tanques de GLP.", categoria: "Próximamente", subtitulo: "Normas de seguridad GLP" },
            { id: 11, nombre: "Convertidor Unidades", url: "Convertidor de unidades Todas las unidades.html", imagen: "ImagenConvertidorUniversalDeUnidades.png", descripcion: "Conversor multipropósito para magnitudes físicas.", categoria: "Utilidades", subtitulo: "Herramienta Multi-propósito" },
            { id: 12, nombre: "Errores CPD y CA", url: "Error de códigos de aplicación, calentadores.txt", imagen: "ImgErroresCPD_CA.png", descripcion: "Diagnostico segun error declarado por el equipo.", categoria: "Utilidades", subtitulo: "Diagnóstico de fallas" }
        ];

        let dbUsers = JSON.parse(localStorage.getItem('sofia_users')) || DEFAULT_USERS;
        let currentUser = null;
        let currentProfile = "General";
        let myInterests = JSON.parse(localStorage.getItem('sofia_favs')) || [];
        
        const fallbackImg = "https://images.unsplash.com/photo-1518770660439-4636190af475?q=80&w=2070";

        // --- INICIO ---
        window.addEventListener('load', () => {
            gestionarAudio();
            
            const session = JSON.parse(localStorage.getItem('sofia_session'));
            if (session) {
                currentUser = dbUsers.find(u => u.u === session.u) || session;
                iniciarInterfaz();
            } else {
                document.getElementById('login-screen').style.display = 'flex';
            }
            
            window.addEventListener('scroll', () => {
                const nav = document.getElementById('navbar');
                if(window.scrollY > 50) nav.classList.add('scrolled');
                else nav.classList.remove('scrolled');
            });
        });

        // --- AUDIO ---
        function gestionarAudio() {
            const player = document.getElementById('bg-music');
            const tracks = [
                "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3",
                "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3"
            ];
            
            // Recuperar o iniciar
            const savedTrack = localStorage.getItem('audio_track') || tracks[0];
            const savedTime = localStorage.getItem('audio_time') || 0;
            
            player.src = savedTrack;
            player.currentTime = savedTime;
            
            // Guardar periodicamente
            setInterval(() => {
                localStorage.setItem('audio_time', player.currentTime);
            }, 1000);

            // Intentar reproducir
            player.play().catch(() => {
                document.body.addEventListener('click', () => { 
                    player.play();
                    // Si es nuevo inicio, elegir random
                    if(savedTime == 0) {
                        const rnd = tracks[Math.floor(Math.random()*tracks.length)];
                        player.src = rnd;
                        localStorage.setItem('audio_track', rnd);
                        player.play();
                    }
                }, {once:true});
            });
        }

        // --- LOGIN ---
        function togglePass(id) {
            const x = document.getElementById(id);
            x.type = x.type === "password" ? "text" : "password";
        }

        function intentarLogin(e, type) {
            e.preventDefault();
            let u, p, errBox;
            
            if(type === 'General') {
                u = document.getElementById('user-static').value.trim();
                p = document.getElementById('pass-static').value.trim();
                errBox = document.getElementById('error-static');
                currentProfile = "General";
            } else {
                u = document.getElementById('user-dyn').value.trim();
                p = document.getElementById('pass-dyn').value.trim();
                errBox = document.getElementById('error-dyn');
            }

            const found = dbUsers.find(user => user.u === u && user.p === p);
            
            if (found) {
                currentUser = found;
                localStorage.setItem('sofia_session', JSON.stringify(currentUser));
                errBox.style.display = 'none';
                
                if(type === 'Dynamic') {
                    cerrarModal('modal-login-sec');
                    document.getElementById('profile-gate').style.display = 'none';
                    aplicarEstiloPerfil(document.getElementById('dynamic-login-modal').dataset.target);
                } else {
                    document.getElementById('login-screen').style.opacity = '0';
                    setTimeout(() => {
                        document.getElementById('login-screen').style.display = 'none';
                        document.getElementById('profile-gate').style.display = 'flex';
                    }, 800);
                }
            } else {
                errBox.style.display = 'block';
            }
        }

        function iniciarInterfaz() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('profile-gate').style.display = 'none';
            document.getElementById('main-interface').classList.remove('hidden');
            
            actualizarAvatar();
            renderizarFilas();
            cargarHeroRandom();
        }

        function cerrarSesion() {
            localStorage.removeItem('sofia_session');
            localStorage.removeItem('audio_time');
            location.reload();
        }

        // --- PERFILES ---
        function abrirGate() { 
            document.getElementById('main-interface').classList.add('hidden');
            document.getElementById('profile-gate').style.display = 'flex'; 
        }
        
        function seleccionarPerfil(perfil) {
            if (perfil === 'General') {
                currentProfile = "General";
                aplicarEstiloPerfil("General");
                iniciarInterfaz();
            } else {
                const modal = document.getElementById('modal-login-sec');
                document.getElementById('sec-profile-name').innerText = perfil;
                document.getElementById('dynamic-login-modal').dataset.target = perfil;
                
                let color = perfil === 'Corporativo' ? 'var(--corp-color)' : 'var(--edu-color)';
                modal.querySelector('.modal-box').style.borderTopColor = color;
                modal.style.display = 'flex';
            }
        }

        function aplicarEstiloPerfil(perfil) {
            const badge = document.getElementById('profile-indicator');
            const avatar = document.getElementById('nav-avatar-icon');
            badge.textContent = perfil.toUpperCase();
            
            // Limpiar
            avatar.classList.remove('av-gen', 'av-corp', 'av-edu');
            badge.style.borderColor = "white"; badge.style.color = "white";

            if(currentUser.img) {
                avatar.style.backgroundImage = `url('${currentUser.img}')`;
                avatar.innerHTML = '';
            } else {
                avatar.style.backgroundImage = '';
                if(perfil === 'General') { avatar.classList.add('av-gen'); avatar.innerHTML='<i class="fas fa-tools"></i>'; }
                if(perfil === 'Corporativo') { 
                    avatar.classList.add('av-corp'); avatar.innerHTML='<i class="fas fa-building"></i>'; 
                    badge.style.borderColor = "var(--corp-color)"; badge.style.color = "var(--corp-color)";
                }
                if(perfil === 'Académico') { 
                    avatar.classList.add('av-edu'); avatar.innerHTML='<i class="fas fa-graduation-cap"></i>'; 
                    badge.style.borderColor = "var(--edu-color)"; badge.style.color = "var(--edu-color)";
                }
            }
        }

        function actualizarAvatar() {
            aplicarEstiloPerfil(currentProfile);
        }

        // --- UI GENERATION ---
        function renderizarFilas() {
            const container = document.getElementById('rows-container');
            container.innerHTML = "";
            const cats = [...new Set(TOOLS.map(t => t.categoria))];
            
            cats.forEach(cat => {
                const items = TOOLS.filter(t => t.categoria === cat);
                const row = document.createElement('div'); row.className = 'row';
                
                row.innerHTML = `<h3 class="row-title">${cat}</h3><div class="row-slider">${items.map(t => crearTile(t)).join('')}</div>`;
                container.appendChild(row);
            });
        }

        function crearTile(t) {
            const img = t.imagen.includes('.') ? t.imagen : t.imagen + '.jpg';
            return `
                <div class="tile" onclick="abrirDetalles(${t.id})">
                    <img src="${img}" class="tile-img" onerror="this.src='${fallbackImg}'">
                    <div class="tile-info">
                        <div class="tile-actions">
                            <div class="action-btn" style="background:white; color:black;" onclick="event.stopPropagation(); abrirApp('${t.nombre}', '${t.url}')"><i class="fas fa-play"></i></div>
                            <div class="action-btn" onclick="event.stopPropagation(); abrirDetalles(${t.id})"><i class="fas fa-chevron-down"></i></div>
                        </div>
                        <div class="tile-name">${t.nombre}</div>
                        <div class="tile-subtitle" style="font-size:0.7rem; color:#aaa; margin-bottom:5px;">${t.subtitulo}</div>
                        <div class="tile-meta">Recomendado</div>
                    </div>
                </div>
            `;
        }

        function cargarHeroRandom() {
            const t = TOOLS[Math.floor(Math.random() * TOOLS.length)];
            const img = t.imagen.includes('.') ? t.imagen : t.imagen + '.jpg';
            document.getElementById('hero-bg').style.backgroundImage = `linear-gradient(rgba(0,0,0,0.2), var(--bg-black)), url('${img}')`;
            document.getElementById('hero-title').innerText = t.nombre;
            document.getElementById('hero-desc').innerText = t.descripcion;
            
            const btnPlay = document.getElementById('hero-play');
            const newBtn = btnPlay.cloneNode(true);
            btnPlay.parentNode.replaceChild(newBtn, btnPlay);
            newBtn.onclick = () => abrirApp(t.nombre, t.url);
        }

        // --- EDICION PERFIL ---
        function abrirEditor() {
            if(!currentUser) return;
            document.getElementById('edit-email').value = currentUser.u;
            document.getElementById('edit-pass').value = currentUser.p;
            document.getElementById('edit-name').value = currentUser.n || "";
            document.getElementById('edit-lastname').value = currentUser.a || "";
            document.getElementById('edit-profession').value = currentUser.profesion || "";
            document.getElementById('edit-area').value = currentUser.area || "";
            toggleConsultorArea();
            
            const pv = document.getElementById('preview-avatar');
            if(currentUser.img) {
                pv.style.backgroundImage = `url('${currentUser.img}')`;
                pv.innerHTML = '';
            } else {
                pv.style.backgroundImage = '';
                pv.innerHTML = '<i class="fas fa-camera" style="font-size:2rem; color:#666;"></i>';
            }
            document.getElementById('modal-editor').style.display = 'flex';
        }

        function toggleConsultorArea() {
            const area = document.getElementById('edit-area').value;
            const div = document.getElementById('consultant-area-group');
            if(div) { // Validar existencia si no se creó dinámicamente
                 if (area === 'Consultor') div.classList.remove('hidden'); else div.classList.add('hidden');
            }
        }

        function previewImg(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const preview = document.getElementById('preview-avatar');
                    preview.style.backgroundImage = `url('${e.target.result}')`;
                    preview.innerHTML = '';
                }
                reader.readAsDataURL(file);
            }
        }

        function guardarPerfil() {
            currentUser.n = document.getElementById('edit-name').value;
            currentUser.a = document.getElementById('edit-lastname').value;
            currentUser.profesion = document.getElementById('edit-profession').value;
            currentUser.area = document.getElementById('edit-area').value;

            const fileInput = document.getElementById('avatar-upload');
            if (fileInput.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    currentUser.img = e.target.result;
                    guardarYSalirEdicion();
                };
                reader.readAsDataURL(fileInput.files[0]);
            } else {
                guardarYSalirEdicion();
            }
        }

        function guardarYSalirEdicion() {
            const idx = dbUsers.findIndex(u => u.u === currentUser.u);
            if(idx !== -1) dbUsers[idx] = currentUser;
            
            localStorage.setItem('sofia_users', JSON.stringify(dbUsers));
            localStorage.setItem('sofia_session', JSON.stringify(currentUser));
            
            cerrarModal('modal-editor');
            actualizarAvatar();
            alert("Perfil Actualizado");
        }

        // --- DETALLES / BUSQUEDA ---
        function abrirDetalles(id) {
            const t = TOOLS.find(i => i.id === id);
            document.getElementById('detail-title').innerText = t.nombre;
            document.getElementById('detail-desc').innerText = t.descripcion;
            document.getElementById('detail-cat').innerText = t.categoria;
            
            const img = t.imagen.includes('.') ? t.imagen : t.imagen + '.jpg';
            document.getElementById('detail-banner').style.backgroundImage = `url('${img}')`;
            
            const btn = document.getElementById('detail-open');
            btn.onclick = () => abrirApp(t.nombre, t.url);
            
            document.getElementById('modal-details').style.display = 'flex';
        }

        function abrirApp(titulo, url) {
            cerrarModal('modal-details');
            document.getElementById('viewer').style.display = 'flex';
            document.getElementById('app-frame').src = url;
        }

        function toggleSearch() {
            const box = document.getElementById('search-box');
            box.classList.toggle('active');
            if(box.classList.contains('active')) document.getElementById('search-input').focus();
            else { 
                document.getElementById('search-input').value = ""; 
                renderizarFilas(); // Restaurar
            }
        }

        function filtrar(val) {
            const term = val.toLowerCase();
            const container = document.getElementById('rows-container');
            container.innerHTML = "";
            
            const results = TOOLS.filter(t => 
                t.nombre.toLowerCase().includes(term) || 
                t.descripcion.toLowerCase().includes(term) ||
                t.categoria.toLowerCase().includes(term)
            );
            
            if(results.length > 0) {
                const grid = document.createElement('div');
                grid.className = 'search-results-grid';
                results.forEach(t => {
                    const div = document.createElement('div');
                    div.innerHTML = crearTile(t);
                    // Extraer el elemento del string HTML para appendearlo
                    grid.appendChild(div.firstElementChild);
                });
                container.appendChild(grid);
            } else {
                container.innerHTML = `<div style="text-align:center; padding:40px; color:#666;">No se encontraron resultados</div>`;
            }
        }

        function cerrarModal(id) { document.getElementById(id).style.display = 'none'; }
        function mostrarVideo() { document.getElementById('video-modal').style.display = 'flex'; document.getElementById('promo-video').play().catch(e=>{}); }

    </script>
</body>
</html>
