<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entalpia | ERP & CRM Cloud</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #2563EB; --primary-dark: #1E40AF;
            --secondary: #64748B; --success: #10B981; --danger: #EF4444;
            --bg-body: #F3F4F6; --bg-surface: #FFFFFF; --bg-sidebar: #0F172A;
            --text-main: #111827; --text-muted: #6B7280; --text-on-dark: #F9FAFB;
            --sidebar-width: 260px; --header-height: 64px; --radius: 8px;
            --shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-body); color: var(--text-main); height: 100vh; overflow: hidden; }

        /* MODALES */
        .full-screen-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.95); display: flex; align-items: center; justify-content: center; z-index: 9999;
        }
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 500; justify-content: center; align-items: center;
        }
        .modal-box { background: white; padding: 24px; border-radius: 8px; width: 500px; max-width: 90%; }
        
        .login-card { background: white; padding: 40px; border-radius: 12px; width: 400px; text-align: center; }
        .form-input { width: 100%; padding: 12px; margin-bottom: 16px; border: 1px solid #E2E8F0; border-radius: 6px; }
        .form-label { display: block; text-align: left; margin-bottom: 5px; font-weight: 500; font-size: 0.9rem; }
        
        .btn { padding: 10px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; width: 100%; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-outline { background: white; border: 1px solid #D1D5DB; color: var(--text-main); }
        .btn-danger { background: #FEE2E2; color: var(--danger); }
        .btn-logout { background: #FEF2F2; color: var(--danger); border: 1px solid #FECACA; }

        /* LAYOUT */
        #app-container { display: none; width: 100%; height: 100%; }
        .sidebar { width: var(--sidebar-width); background: var(--bg-sidebar); color: var(--text-on-dark); display: flex; flex-direction: column; }
        .brand { height: var(--header-height); display: flex; align-items: center; padding: 0 24px; font-weight: 700; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .nav-menu { flex: 1; padding: 20px; overflow-y: auto; }
        .nav-item { display: flex; align-items: center; padding: 12px; color: #CBD5E1; cursor: pointer; border-radius: 6px; margin-bottom: 4px; }
        .nav-item:hover, .nav-item.active { background: rgba(255,255,255,0.1); color: white; }
        .nav-item.active { background: var(--primary); }
        .nav-icon { margin-right: 12px; width: 20px; text-align: center; }
        .main-content { flex: 1; display: flex; flex-direction: column; }
        header { height: var(--header-height); background: white; border-bottom: 1px solid #E5E7EB; display: flex; justify-content: space-between; align-items: center; padding: 0 32px; }
        
        /* VISTAS */
        .view-section { display: none; height: 100%; overflow-y: auto; padding: 32px; }
        .view-section.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; } }

        /* TABLAS Y CARDS */
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 20px; }
        .card { background: white; padding: 20px; border-radius: 8px; border: 1px solid #E5E7EB; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .stat-value { font-size: 1.5rem; font-weight: 700; display: block; margin: 10px 0; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #F3F4F6; }
        th { background: #F9FAFB; color: #6B7280; font-weight: 600; }
        .status-badge { padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; font-weight: 600; }
        .status-success { background: #DEF7EC; color: #03543F; }
        
        @media (max-width: 1000px) { .grid-4 { grid-template-columns: 1fr 1fr; } .sidebar { width: 60px; } .brand span, .nav-item span:last-child { display: none; } }
    </style>
</head>
<body>

    <!-- LOADING -->
    <div id="loading-overlay" class="full-screen-modal" style="background: white; z-index: 10000; color: black;">
        <div>Iniciando Sistema...</div>
    </div>

    <!-- LOGIN -->
    <div id="login-modal" class="full-screen-modal">
        <div class="login-card">
            <h2 id="login-title" style="margin-bottom: 10px;">ENTALPIA <span style="color:var(--primary)">ERP</span></h2>
            <p style="color:#666; font-size:0.9rem; margin-bottom:20px;">Acceso Corporativo Seguro</p>
            
            <form id="auth-form">
                <input type="email" id="email" class="form-input" placeholder="usuario@empresa.com" required>
                <input type="password" id="password" class="form-input" placeholder="Contrase침a" required>
                <button type="submit" id="login-btn-action" class="btn btn-primary">Acceder</button>
            </form>
            
            <div id="login-error" style="color: var(--danger); margin-top: 10px; font-size: 0.85rem;"></div>
            <div style="margin-top: 15px; font-size: 0.85rem; cursor: pointer; color: var(--primary);" onclick="window.toggleAuthMode()">
                <span id="toggle-auth-text">쯅o tienes cuenta? Reg칤strate</span>
            </div>
            <div style="margin-top: 20px; font-size: 0.75rem; color: #aaa;">Modo: <span id="system-mode">Detectando...</span></div>
        </div>
    </div>

    <!-- APP -->
    <div id="app-container">
        <aside class="sidebar">
            <div class="brand">ENTALPIA <span>ERP</span></div>
            <div class="nav-menu">
                <div class="nav-item active" onclick="window.navigateTo('dashboard', this)"><span class="nav-icon">游늵</span> <span>Dashboard</span></div>
                <div class="nav-item" onclick="window.navigateTo('clients', this)"><span class="nav-icon">游논</span> <span>Clientes</span></div>
                <div class="nav-item" onclick="window.navigateTo('projects', this)"><span class="nav-icon">游</span> <span>Proyectos</span></div>
                <div class="nav-item" onclick="window.navigateTo('inventory', this)"><span class="nav-icon">游닍</span> <span>Inventario</span></div>
                <div class="nav-item" onclick="window.navigateTo('invoices', this)"><span class="nav-icon">游눱</span> <span>Facturas</span></div>
            </div>
            <div style="padding: 20px; border-top: 1px solid rgba(255,255,255,0.1); cursor: pointer;" onclick="window.handleLogout()">
                <div style="font-size: 0.8rem; opacity: 0.7;">Usuario Conectado</div>
                <div id="user-email-display" style="font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">...</div>
            </div>
        </aside>

        <main class="main-content">
            <header>
                <h2 id="page-title">Panel de Control</h2>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-logout" onclick="window.handleLogout()">Salir</button>
                    <button id="btn-new" class="btn btn-primary" style="display: none;" onclick="window.openCreateModal()">+ Nuevo</button>
                </div>
            </header>

            <!-- VISTAS -->
            <div id="view-dashboard" class="view-section active">
                <div class="grid-4">
                    <div class="card"><span style="color:#666">Ingresos</span><span class="stat-value" id="kpi-income">$0</span></div>
                    <div class="card"><span style="color:#666">Proyectos</span><span class="stat-value" id="kpi-projects">0</span></div>
                    <div class="card"><span style="color:#666">Clientes</span><span class="stat-value" id="kpi-clients">0</span></div>
                    <div class="card"><span style="color:#666">Stock</span><span class="stat-value" id="kpi-stock">0</span></div>
                </div>
                <div class="card">
                    <h3>Bienvenido al Sistema</h3>
                    <p style="color:#666; margin-top:5px;">Selecciona una opci칩n del men칰 lateral para comenzar a gestionar.</p>
                </div>
            </div>

            <div id="view-clients" class="view-section">
                <div class="card">
                    <h3>Directorio de Clientes</h3>
                    <div id="list-clients"></div> <!-- Tabla inyectada por JS -->
                </div>
            </div>
            
            <div id="view-projects" class="view-section">
                <div class="card"><h3>Proyectos Activos</h3><div id="list-projects"></div></div>
            </div>
            
            <div id="view-inventory" class="view-section">
                <div class="card"><h3>Inventario</h3><div id="list-inventory"></div></div>
            </div>
            
            <div id="view-invoices" class="view-section">
                <div class="card"><h3>Facturaci칩n</h3><div id="list-invoices"></div></div>
            </div>
        </main>
    </div>

    <!-- MODAL GEN칄RICO -->
    <div id="generic-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 id="modal-title" style="margin-bottom: 20px;">Nuevo Registro</h3>
            <div id="modal-fields"></div>
            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                <button class="btn btn-outline" onclick="window.closeModal()">Cancelar</button>
                <button class="btn btn-primary" id="modal-save-btn">Guardar</button>
            </div>
        </div>
    </div>

    <!-- L칍GICA DEL SISTEMA -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, deleteDoc, doc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- ESTADO GLOBAL ---
        let db, auth;
        let isLocalMode = false;
        let currentUser = null;
        let isRegistering = false;
        let currentView = 'dashboard';
        const LOCAL_KEY = 'entalpia_db_v2';

        // --- DEFINICI칍N DE CAMPOS ---
        const schemas = {
            'clients': [
                { id: 'name', label: 'Nombre', type: 'text' },
                { id: 'company', label: 'Empresa', type: 'text' },
                { id: 'email', label: 'Email', type: 'email' }
            ],
            'projects': [
                { id: 'name', label: 'Proyecto', type: 'text' },
                { id: 'client', label: 'Cliente', type: 'text' },
                { id: 'status', label: 'Estado', type: 'select', options: ['Activo', 'Pendiente', 'Finalizado'] }
            ],
            'inventory': [
                { id: 'product', label: 'Producto', type: 'text' },
                { id: 'stock', label: 'Stock', type: 'number' },
                { id: 'price', label: 'Precio', type: 'number' }
            ],
            'invoices': [
                { id: 'number', label: 'N춿 Factura', type: 'text' },
                { id: 'client', label: 'Cliente', type: 'text' },
                { id: 'total', label: 'Total', type: 'number' }
            ]
        };

        // --- INICIALIZACI칍N ---
        async function initSystem() {
            try {
                if (typeof __firebase_config !== 'undefined') {
                    const app = initializeApp(JSON.parse(__firebase_config));
                    auth = getAuth(app);
                    db = getFirestore(app);
                    document.getElementById('system-mode').textContent = "Nube (Firebase)";
                    document.getElementById('system-mode').style.color = "green";
                    
                    onAuthStateChanged(auth, (user) => {
                        handleSession(user);
                    });
                } else {
                    throw new Error("No config");
                }
            } catch (e) {
                console.log("Fallback a Modo Local");
                isLocalMode = true;
                document.getElementById('system-mode').textContent = "Local (Navegador)";
                document.getElementById('system-mode').style.color = "orange";
                
                const storedUser = sessionStorage.getItem('entalpia_user');
                handleSession(storedUser ? JSON.parse(storedUser) : null);
            }
        }

        function handleSession(user) {
            document.getElementById('loading-overlay').style.display = 'none';
            if (user) {
                currentUser = user;
                document.getElementById('user-email-display').textContent = user.email;
                document.getElementById('login-modal').style.display = 'none';
                document.getElementById('app-container').style.display = 'flex';
                loadAllData();
            } else {
                currentUser = null;
                document.getElementById('app-container').style.display = 'none';
                document.getElementById('login-modal').style.display = 'flex';
            }
        }

        // --- FUNCIONES GLOBALES (Window Binding) ---
        window.handleAuth = async (e) => {
            if(e) e.preventDefault();
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            const errorDiv = document.getElementById('login-error');
            
            if (!email || !pass) return errorDiv.textContent = "Completa todos los campos";
            errorDiv.textContent = "Procesando...";

            if (isLocalMode) {
                // Simulaci칩n Local
                setTimeout(() => {
                    const users = JSON.parse(localStorage.getItem('entalpia_users') || '[]');
                    const existing = users.find(u => u.email === email);
                    
                    if (isRegistering) {
                        if (existing) errorDiv.textContent = "El usuario ya existe.";
                        else {
                            const newUser = { uid: 'loc_' + Date.now(), email, pass };
                            users.push(newUser);
                            localStorage.setItem('entalpia_users', JSON.stringify(users));
                            sessionStorage.setItem('entalpia_user', JSON.stringify(newUser));
                            handleSession(newUser);
                        }
                    } else {
                        if (existing && existing.pass === pass) {
                            sessionStorage.setItem('entalpia_user', JSON.stringify(existing));
                            handleSession(existing);
                        } else {
                            errorDiv.textContent = "Credenciales incorrectas.";
                        }
                    }
                }, 500);
            } else {
                // Firebase Real
                try {
                    if (isRegistering) await createUserWithEmailAndPassword(auth, email, pass);
                    else await signInWithEmailAndPassword(auth, email, pass);
                } catch (err) {
                    errorDiv.textContent = "Error: " + err.code;
                }
            }
        };

        window.handleLogout = async () => {
            if (isLocalMode) sessionStorage.removeItem('entalpia_user');
            else try { await signOut(auth); } catch(e){}
            window.location.reload(); 
        };

        window.toggleAuthMode = () => {
            isRegistering = !isRegistering;
            const btn = document.getElementById('login-btn-action');
            const txt = document.getElementById('toggle-auth-text');
            const title = document.getElementById('login-title');
            
            if (isRegistering) {
                title.innerHTML = "Crear Cuenta";
                btn.textContent = "Registrarme";
                txt.textContent = "쯏a tienes cuenta? Inicia Sesi칩n";
            } else {
                title.innerHTML = 'ENTALPIA <span style="color:var(--primary)">ERP</span>';
                btn.textContent = "Acceder";
                txt.textContent = "쯅o tienes cuenta? Reg칤strate";
            }
        };

        window.navigateTo = (viewId, element) => {
            currentView = viewId;
            // UI Update
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${viewId}`).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            if(element) element.classList.add('active');

            // Titles
            const titles = { 'dashboard': 'Panel', 'clients': 'Clientes', 'projects': 'Proyectos', 'inventory': 'Inventario', 'invoices': 'Facturaci칩n' };
            document.getElementById('page-title').textContent = titles[viewId];
            
            // Show/Hide New Button
            document.getElementById('btn-new').style.display = viewId === 'dashboard' ? 'none' : 'block';
        };

        // --- GESTI칍N DE DATOS ---
        function loadAllData() {
            ['clients', 'projects', 'inventory', 'invoices'].forEach(col => loadCollection(col));
        }

        function loadCollection(colName) {
            if (isLocalMode) {
                const dbData = JSON.parse(localStorage.getItem(LOCAL_KEY) || '{}');
                const userSpace = dbData[currentUser.uid] || {};
                const items = userSpace[colName] || [];
                renderTable(colName, items);
                updateKPI(colName, items);
            } else {
                const colRef = collection(db, 'artifacts', (typeof __app_id !== 'undefined' ? __app_id : 'default'), 'users', currentUser.uid, colName);
                onSnapshot(query(colRef, orderBy('createdAt', 'desc')), (snap) => {
                    const items = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    renderTable(colName, items);
                    updateKPI(colName, items);
                });
            }
        }

        window.addItem = async (colName, data) => {
            if (isLocalMode) {
                const dbData = JSON.parse(localStorage.getItem(LOCAL_KEY) || '{}');
                if (!dbData[currentUser.uid]) dbData[currentUser.uid] = {};
                if (!dbData[currentUser.uid][colName]) dbData[currentUser.uid][colName] = [];
                
                dbData[currentUser.uid][colName].unshift({ id: 'loc_item_'+Date.now(), ...data, createdAt: Date.now() });
                localStorage.setItem(LOCAL_KEY, JSON.stringify(dbData));
                loadCollection(colName); // Reload manual
            } else {
                const colRef = collection(db, 'artifacts', (typeof __app_id !== 'undefined' ? __app_id : 'default'), 'users', currentUser.uid, colName);
                await addDoc(colRef, { ...data, createdAt: serverTimestamp() });
            }
        };

        window.deleteItem = async (colName, id) => {
            if(!confirm("쮼liminar?")) return;
            if(isLocalMode) {
                const dbData = JSON.parse(localStorage.getItem(LOCAL_KEY) || '{}');
                const list = dbData[currentUser.uid][colName];
                dbData[currentUser.uid][colName] = list.filter(x => x.id !== id);
                localStorage.setItem(LOCAL_KEY, JSON.stringify(dbData));
                loadCollection(colName);
            } else {
                const docRef = doc(db, 'artifacts', (typeof __app_id !== 'undefined' ? __app_id : 'default'), 'users', currentUser.uid, colName, id);
                await deleteDoc(docRef);
            }
        };

        // --- RENDERIZADO ---
        function renderTable(colName, items) {
            const container = document.getElementById(`list-${colName}`);
            if (!container) return; // Si es dashboard no hay tabla
            
            if (items.length === 0) {
                container.innerHTML = '<div style="padding:20px; color:#888; text-align:center;">No hay registros.</div>';
                return;
            }

            let html = '<table><thead><tr>';
            schemas[colName].forEach(f => html += `<th>${f.label}</th>`);
            html += '<th>Acci칩n</th></tr></thead><tbody>';

            items.forEach(item => {
                html += '<tr>';
                schemas[colName].forEach(f => {
                    let val = item[f.id];
                    if(f.type === 'number') val = (colName === 'invoices' || colName === 'inventory') && f.id !== 'stock' ? '$'+val : val;
                    if(f.id === 'status') val = `<span class="status-badge status-success">${val}</span>`;
                    html += `<td>${val}</td>`;
                });
                html += `<td><button style="color:red; background:none; border:none; cursor:pointer;" onclick="window.deleteItem('${colName}', '${item.id}')">Eliminar</button></td></tr>`;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function updateKPI(colName, items) {
            if(colName === 'invoices') {
                const total = items.reduce((sum, i) => sum + parseFloat(i.total||0), 0);
                document.getElementById('kpi-income').textContent = '$' + total.toLocaleString();
            }
            if(colName === 'projects') document.getElementById('kpi-projects').textContent = items.length;
            if(colName === 'clients') document.getElementById('kpi-clients').textContent = items.length;
            if(colName === 'inventory') {
                const stock = items.reduce((sum, i) => sum + parseInt(i.stock||0), 0);
                document.getElementById('kpi-stock').textContent = stock;
            }
        }

        // --- MODAL DE CREACI칍N ---
        window.openCreateModal = () => {
            const fields = schemas[currentView];
            if(!fields) return;
            
            const container = document.getElementById('modal-fields');
            container.innerHTML = '';
            
            fields.forEach(f => {
                let input;
                if(f.type === 'select') {
                    input = `<select id="inp-${f.id}" class="form-input">${f.options.map(o => `<option value="${o}">${o}</option>`).join('')}</select>`;
                } else {
                    input = `<input id="inp-${f.id}" type="${f.type}" class="form-input" placeholder="${f.label}">`;
                }
                container.innerHTML += `<div><label class="form-label">${f.label}</label>${input}</div>`;
            });
            
            document.getElementById('generic-modal').style.display = 'flex';
            
            document.getElementById('modal-save-btn').onclick = () => {
                const data = {};
                let valid = true;
                fields.forEach(f => {
                    const val = document.getElementById(`inp-${f.id}`).value;
                    if(!val) valid = false;
                    data[f.id] = val;
                });
                if(!valid) return alert("Completa todos los campos");
                
                window.addItem(currentView, data);
                window.closeModal();
            };
        };

        window.closeModal = () => document.getElementById('generic-modal').style.display = 'none';

        // --- ARRANQUE ---
        document.getElementById('auth-form').addEventListener('submit', window.handleAuth);
        initSystem();

    </script>
</body>
</html>
