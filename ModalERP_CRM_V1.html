<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entalpia | ERP & CRM Cloud</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- FIREBASE COMPAT (CDN estable) -->
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-storage-compat.js"></script>

    <style>
        :root {
            --primary: #2563EB; --primary-dark: #1E40AF;
            --secondary: #64748B; --success: #10B981; --danger: #EF4444;
            --bg-body: #F3F4F6; --bg-surface: #FFFFFF; --bg-sidebar: #0F172A;
            --text-main: #111827; --text-muted: #6B7280; --text-on-dark: #F9FAFB;
            --sidebar-width: 260px; --header-height: 64px; --radius: 8px;
            --shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-body); color: var(--text-main); height: 100vh; overflow: hidden; }

        /* MODALES */
        .full-screen-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.95); display: flex; align-items: center; justify-content: center; z-index: 9999;
        }
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 500; justify-content: center; align-items: center;
        }
        .modal-box { background: white; padding: 24px; border-radius: 8px; width: 500px; max-width: 90%; }
        
        .login-card { background: white; padding: 40px; border-radius: 12px; width: 400px; text-align: center; }
        .form-input { width: 100%; padding: 12px; margin-bottom: 16px; border: 1px solid #E2E8F0; border-radius: 6px; }
        .form-label { display: block; text-align: left; margin-bottom: 5px; font-weight: 500; font-size: 0.9rem; }
        
        .btn { padding: 10px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; width: 100%; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-outline { background: white; border: 1px solid #D1D5DB; color: var(--text-main); }
        .btn-danger { background: #FEE2E2; color: var(--danger); }
        .btn-logout { background: #FEF2F2; color: var(--danger); border: 1px solid #FECACA; }
        .btn-admin { background: #312e81; color: #a5b4fc; border: 1px solid #4338ca; width: 100%; margin-top: 20px; text-align: center; display: block; padding: 10px; border-radius: 6px; text-decoration: none;}

        .btn-download { background: #EFF6FF; color: var(--primary); border: 1px solid #BFDBFE; padding: 4px 10px; font-size: 0.75rem; text-decoration: none; display: inline-block; border-radius: 4px; }

        /* LAYOUT */
        #app-container { display: none; width: 100%; height: 100%; }
        .sidebar { width: var(--sidebar-width); background: var(--bg-sidebar); color: var(--text-on-dark); display: flex; flex-direction: column; }
        .brand { height: var(--header-height); display: flex; align-items: center; padding: 0 24px; font-weight: 700; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .nav-menu { flex: 1; padding: 20px; overflow-y: auto; }
        .nav-item { display: flex; align-items: center; padding: 12px; color: #CBD5E1; cursor: pointer; border-radius: 6px; margin-bottom: 4px; }
        .nav-item:hover, .nav-item.active { background: rgba(255,255,255,0.1); color: white; }
        .nav-item.active { background: var(--primary); }
        .nav-icon { margin-right: 12px; width: 20px; text-align: center; }
        .main-content { flex: 1; display: flex; flex-direction: column; }
        header { height: var(--header-height); background: white; border-bottom: 1px solid #E5E7EB; display: flex; justify-content: space-between; align-items: center; padding: 0 32px; }
        
        /* VISTAS */
        .view-section { display: none; height: 100%; overflow-y: auto; padding: 32px; }
        .view-section.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; } }

        /* TABLAS Y CARDS */
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 20px; }
        .card { background: white; padding: 20px; border-radius: 8px; border: 1px solid #E5E7EB; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .stat-value { font-size: 1.5rem; font-weight: 700; display: block; margin: 10px 0; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #F3F4F6; }
        th { background: #F9FAFB; color: #6B7280; font-weight: 600; }
        .status-badge { padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; font-weight: 600; }
        .status-success { background: #DEF7EC; color: #03543F; }
        .status-error { background: #FDE8E8; color: #9B1C1C; }
        
        .storage-warning { background: #FFF7ED; border: 1px solid #FED7AA; color: #C2410C; padding: 10px; border-radius: 6px; margin-bottom: 20px; font-size: 0.85rem; display: none; }

        @media (max-width: 1000px) { .grid-4 { grid-template-columns: 1fr 1fr; } .sidebar { width: 60px; } .brand span, .nav-item span:last-child { display: none; } }
    </style>
</head>
<body>

    <!-- LOADING -->
    <div id="loading-overlay" class="full-screen-modal" style="background: white; z-index: 10000; color: black;">
        <div style="text-align: center;">
            <div style="font-weight: bold; margin-bottom: 5px;">Entalpia Secure ERP</div>
            <div style="font-size: 0.8rem; color: #666;" id="loading-text">Verificando credenciales...</div>
        </div>
    </div>

    <!-- LOGIN -->
    <div id="login-modal" class="full-screen-modal">
        <div class="login-card">
            <h2 id="login-title" style="margin-bottom: 10px;">ENTALPIA <span style="color:var(--primary)">ERP</span></h2>
            <p style="color:#666; font-size:0.9rem; margin-bottom:20px;">Acceso exclusivo para miembros activos</p>
            
            <form id="auth-form" onsubmit="window.handleAuth(event)">
                <input type="email" id="email" class="form-input" placeholder="usuario@empresa.com" required>
                <input type="password" id="password" class="form-input" placeholder="Contrase침a" required>
                <button type="submit" id="login-btn-action" class="btn btn-primary">Iniciar Sesi칩n</button>
            </form>
            
            <div id="login-error" style="color: var(--danger); margin-top: 15px; font-size: 0.85rem; background: #FEF2F2; padding: 10px; border-radius: 4px; display: none;"></div>
            
            <div style="margin-top: 20px; font-size: 0.7rem; color: #aaa; border-top: 1px solid #eee; padding-top: 15px;">
                <p>Solo correos autorizados.</p>
                Estado: <span id="system-mode">Detectando...</span>
            </div>
        </div>
    </div>

    <!-- APP -->
    <div id="app-container">
        <aside class="sidebar">
            <div class="brand">ENTALPIA <span>ERP</span></div>
            <div class="nav-menu">
                <div class="nav-item active" onclick="window.navigateTo('dashboard', this)"><span class="nav-icon">游늵</span> <span>Dashboard</span></div>
                <div class="nav-item" onclick="window.navigateTo('clients', this)"><span class="nav-icon">游논</span> <span>Clientes</span></div>
                <div class="nav-item" onclick="window.navigateTo('projects', this)"><span class="nav-icon">游</span> <span>Proyectos</span></div>
                <div class="nav-item" onclick="window.navigateTo('inventory', this)"><span class="nav-icon">游닍</span> <span>Inventario</span></div>
                <div class="nav-item" onclick="window.navigateTo('invoices', this)"><span class="nav-icon">游눱</span> <span>Facturas</span></div>
                <div class="nav-item" onclick="window.navigateTo('documents', this)"><span class="nav-icon">游늯</span> <span>Documentos</span></div>
                
                <!-- Panel Admin (Solo visible para Jose) -->
                <div id="admin-menu-item" class="nav-item" style="display: none; color: #a5b4fc; background: rgba(67, 56, 202, 0.2); margin-top: 20px;" onclick="window.navigateTo('admin', this)">
                    <span class="nav-icon">游댏</span> <span>Admin Usuarios</span>
                </div>
            </div>
            
            <div style="padding: 20px; border-top: 1px solid rgba(255,255,255,0.1); cursor: pointer;" onclick="window.handleLogout()">
                <div style="font-size: 0.7rem; opacity: 0.7; margin-bottom: 2px;">Membres칤a Activa</div>
                <div id="user-email-display" style="font-weight: 600; font-size: 0.85rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">...</div>
                <div id="days-remaining" style="font-size: 0.7rem; color: var(--success); margin-top: 4px;"></div>
            </div>
        </aside>

        <main class="main-content">
            <header>
                <h2 id="page-title">Panel de Control</h2>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-logout" onclick="window.handleLogout()">Salir</button>
                    <button id="btn-new" class="btn btn-primary" style="display: none;" onclick="window.openCreateModal()">+ Nuevo</button>
                </div>
            </header>

            <!-- VISTAS -->
            <div id="view-dashboard" class="view-section active">
                <div id="local-warning" class="storage-warning">
                    丘멆잺 <strong>Modo Local:</strong> La base de datos de usuarios est치 en el almacenamiento local.
                </div>

                <div class="grid-4">
                    <div class="card"><span style="color:#666">Ingresos</span><span class="stat-value" id="kpi-income">$0</span></div>
                    <div class="card"><span style="color:#666">Proyectos</span><span class="stat-value" id="kpi-projects">0</span></div>
                    <div class="card"><span style="color:#666">Clientes</span><span class="stat-value" id="kpi-clients">0</span></div>
                    <div class="card"><span style="color:#666">Docs</span><span class="stat-value" id="kpi-documents">0</span></div>
                </div>
                <div class="card">
                    <h3>Estado de Membres칤a</h3>
                    <p style="color:#666; margin-top:5px;">Tu cuenta corporativa est치 activa. Tienes acceso completo a todos los m칩dulos.</p>
                </div>
            </div>

            <div id="view-clients" class="view-section">
                <div class="card"><h3>Directorio de Clientes</h3><div id="list-clients"></div></div>
            </div>
            <div id="view-projects" class="view-section">
                <div class="card"><h3>Proyectos Activos</h3><div id="list-projects"></div></div>
            </div>
            <div id="view-inventory" class="view-section">
                <div class="card"><h3>Inventario</h3><div id="list-inventory"></div></div>
            </div>
            <div id="view-invoices" class="view-section">
                <div class="card"><h3>Facturaci칩n</h3><div id="list-invoices"></div></div>
            </div>
            <div id="view-documents" class="view-section">
                <div class="card">
                    <h3>Gesti칩n Documental</h3>
                    <div id="list-documents"></div>
                </div>
            </div>

            <!-- VISTA ADMIN (Solo Jose) -->
            <div id="view-admin" class="view-section">
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
                        <h3>Gesti칩n de Usuarios Autorizados</h3>
                        <button class="btn btn-primary" style="width: auto;" onclick="window.openAdminModal()">+ Agregar Usuario</button>
                    </div>
                    <p style="color:#666; font-size: 0.9rem; margin-bottom: 20px;">
                        Solo los usuarios listados aqu칤 pueden acceder. La membres칤a predeterminada es de 30 d칤as.
                    </p>
                    <div id="list-users-admin"></div>
                </div>
            </div>

        </main>
    </div>

    <!-- MODAL GEN칄RICO (DATOS) -->
    <div id="generic-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 id="modal-title" style="margin-bottom: 20px;">Nuevo Registro</h3>
            <div id="modal-fields"></div>
            
            <div id="upload-progress-container" style="display:none; margin-top:15px;">
                <div style="font-size:0.8rem; margin-bottom:5px;">Subiendo archivo...</div>
                <div style="width:100%; background:#eee; height:6px; border-radius:3px;">
                    <div id="upload-bar" style="width:0%; background:var(--primary); height:100%; border-radius:3px; transition:width 0.3s;"></div>
                </div>
            </div>

            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                <button class="btn btn-outline" onclick="window.closeModal()">Cancelar</button>
                <button class="btn btn-primary" id="modal-save-btn">Guardar</button>
            </div>
        </div>
    </div>

    <!-- MODAL ADMIN (CREAR USUARIO) -->
    <div id="admin-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 style="margin-bottom: 20px; color: #312e81;">Autorizar Nuevo Usuario</h3>
            
            <label class="form-label">Correo Electr칩nico</label>
            <input type="email" id="admin-email" class="form-input" placeholder="empleado@empresa.com">
            
            <label class="form-label">Contrase침a Temporal</label>
            <input type="text" id="admin-pass" class="form-input" placeholder="123456">
            
            <label class="form-label">D칤as de Membres칤a</label>
            <input type="number" id="admin-days" class="form-input" value="30">

            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                <button class="btn btn-outline" onclick="window.closeModal()">Cancelar</button>
                <button class="btn btn-primary" onclick="window.adminCreateUser()">Autorizar Acceso</button>
            </div>
        </div>
    </div>

    <!-- L칍GICA DEL SISTEMA -->
    <script>
        // --- CONFIGURACI칍N PARA GITHUB PAGES ---
        const MANUAL_FIREBASE_CONFIG = {};

        // --- ESTADO ---
        let db, auth, storage;
        let isLocalMode = false;
        let currentUser = null;
        let currentView = 'dashboard';
        const LOCAL_KEY = 'entalpia_db_v4';
        const USERS_KEY = 'entalpia_authorized_users';
        const ADMIN_EMAIL = 'josetangarife14@gmail.com';
        const APP_ID = 'entalpia_app_v1';

        // --- ESQUEMAS DE DATOS ---
        const schemas = {
            'clients': [ { id: 'name', label: 'Nombre', type: 'text' }, { id: 'company', label: 'Empresa', type: 'text' }, { id: 'email', label: 'Email', type: 'email' } ],
            'projects': [ { id: 'name', label: 'Proyecto', type: 'text' }, { id: 'client', label: 'Cliente', type: 'text' }, { id: 'status', label: 'Estado', type: 'select', options: ['Activo', 'Pendiente', 'Finalizado'] } ],
            'inventory': [ { id: 'product', label: 'Producto', type: 'text' }, { id: 'stock', label: 'Stock', type: 'number' }, { id: 'price', label: 'Precio', type: 'number' } ],
            'invoices': [ { id: 'number', label: 'N춿 Factura', type: 'text' }, { id: 'client', label: 'Cliente', type: 'text' }, { id: 'total', label: 'Total', type: 'number' } ],
            'documents': [ { id: 'name', label: 'Nombre', type: 'text' }, { id: 'type', label: 'Tipo', type: 'select', options: ['Contrato', 'Factura', 'Reporte'] }, { id: 'file', label: 'Archivo', type: 'file' } ]
        };

        // --- INICIALIZACI칍N ---
        function initSystem() {
            try {
                let config = MANUAL_FIREBASE_CONFIG.apiKey ? MANUAL_FIREBASE_CONFIG : (typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null);
                
                if (config) {
                    if (!firebase.apps.length) firebase.initializeApp(config);
                    auth = firebase.auth();
                    db = firebase.firestore();
                    storage = firebase.storage();
                    document.getElementById('system-mode').textContent = "Nube (Seguro)";
                    document.getElementById('system-mode').style.color = "green";
                    auth.onAuthStateChanged(validateAndLoadSession);
                } else {
                    throw new Error("No config");
                }
            } catch (e) {
                isLocalMode = true;
                document.getElementById('system-mode').textContent = "Local (Demo)";
                document.getElementById('system-mode').style.color = "orange";
                document.getElementById('local-warning').style.display = 'block';
                
                // Pre-sembrar Admin en Local si no existe
                seedLocalAdmin();
                
                const storedUser = sessionStorage.getItem('entalpia_user');
                validateAndLoadSession(storedUser ? JSON.parse(storedUser) : null);
            }
        }

        // Semilla para que Jose pueda entrar en modo local
        function seedLocalAdmin() {
            const users = JSON.parse(localStorage.getItem(USERS_KEY) || '[]');
            if (!users.find(u => u.email === ADMIN_EMAIL)) {
                // Crear al admin con 30 d칤as
                const expiry = Date.now() + (30 * 24 * 60 * 60 * 1000);
                users.push({ 
                    uid: 'admin_001', 
                    email: ADMIN_EMAIL, 
                    password: '1204', // Contrase침a para modo local
                    role: 'admin',
                    expiryDate: expiry
                });
                localStorage.setItem(USERS_KEY, JSON.stringify(users));
                console.log("Admin local pre-creado.");
            }
        }

        // --- VALIDACI칍N DE SEGURIDAD (GATEKEEPER) ---
        async function validateAndLoadSession(user) {
            document.getElementById('loading-overlay').style.display = 'none';
            const errorDiv = document.getElementById('login-error');
            errorDiv.style.display = 'none';

            if (!user) {
                showLogin();
                return;
            }

            // Verificar si est치 autorizado y membres칤a activa
            let userData = null;
            
            if (isLocalMode) {
                const users = JSON.parse(localStorage.getItem(USERS_KEY) || '[]');
                userData = users.find(u => u.email === user.email);
            } else {
                // Firebase: Buscar en colecci칩n 'authorized_users'
                // Nota: En producci칩n esto deber칤a ser una regla de seguridad o Cloud Function
                // Aqu칤 simulamos buscando el doc
                try {
                    const snap = await db.collection('authorized_users').doc(user.email).get();
                    if (snap.exists) userData = snap.data();
                } catch (e) { console.error(e); }
            }

            // CHEQUEOS DE SEGURIDAD
            if (!userData) {
                if(isLocalMode) alert("ERROR CR칈TICO: Usuario no encontrado en base de datos local.");
                else alert("Acceso Denegado: Tu correo no est치 en la lista de autorizados.");
                await handleLogout();
                return;
            }

            const now = Date.now();
            if (userData.expiryDate < now) {
                errorDiv.textContent = "MEMBRES칈A VENCIDA. Por favor contacta a soporte para renovar tu suscripci칩n.";
                errorDiv.style.display = 'block';
                await handleLogout(false); // Logout sin recargar para mostrar mensaje
                return;
            }

            // 칄XITO
            currentUser = { ...user, ...userData }; // Mezclar auth + db data
            document.getElementById('user-email-display').textContent = currentUser.email;
            
            // Calcular d칤as restantes
            const daysLeft = Math.ceil((userData.expiryDate - now) / (1000 * 60 * 60 * 24));
            const daysEl = document.getElementById('days-remaining');
            daysEl.textContent = `${daysLeft} d칤as restantes`;
            if(daysLeft < 5) daysEl.style.color = "var(--danger)";

            // Mostrar Panel Admin si es Jose
            if (currentUser.email === ADMIN_EMAIL) {
                document.getElementById('admin-menu-item').style.display = 'flex';
            }

            document.getElementById('login-modal').style.display = 'none';
            document.getElementById('app-container').style.display = 'flex';
            loadAllData();
        }

        function showLogin() {
            currentUser = null;
            document.getElementById('app-container').style.display = 'none';
            document.getElementById('login-modal').style.display = 'flex';
        }

        // --- AUTH ACTIONS ---
        window.handleAuth = async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value.trim();
            const pass = document.getElementById('password').value.trim();
            const errorDiv = document.getElementById('login-error');
            errorDiv.style.display = 'none';

            if (!email || !pass) return;

            if (isLocalMode) {
                // Auth Local Simulada
                const users = JSON.parse(localStorage.getItem(USERS_KEY) || '[]');
                const user = users.find(u => u.email === email && u.password === pass);
                if (user) {
                    sessionStorage.setItem('entalpia_user', JSON.stringify(user));
                    validateAndLoadSession(user);
                } else {
                    errorDiv.textContent = "Credenciales incorrectas o usuario no registrado.";
                    errorDiv.style.display = 'block';
                }
            } else {
                // Auth Firebase
                try {
                    await auth.signInWithEmailAndPassword(email, pass);
                    // validateAndLoadSession se llama autom치ticamente por el listener
                } catch (err) {
                    errorDiv.textContent = "Error de acceso: " + err.message;
                    errorDiv.style.display = 'block';
                }
            }
        };

        window.handleLogout = async (reload = true) => {
            if (isLocalMode) sessionStorage.removeItem('entalpia_user');
            else try { await auth.signOut(); } catch(e){}
            if (reload) window.location.reload();
            else showLogin();
        };

        // --- ADMIN MODULE ---
        window.openAdminModal = () => document.getElementById('admin-modal').style.display = 'flex';
        
        window.adminCreateUser = async () => {
            if (currentUser.email !== ADMIN_EMAIL) return alert("Acci칩n no autorizada");
            
            const email = document.getElementById('admin-email').value;
            const pass = document.getElementById('admin-pass').value;
            const days = parseInt(document.getElementById('admin-days').value);
            
            if(!email || !pass) return alert("Faltan datos");

            const expiry = Date.now() + (days * 24 * 60 * 60 * 1000);
            const newUser = { email, password: pass, expiryDate: expiry, createdAt: Date.now() };

            if (isLocalMode) {
                const users = JSON.parse(localStorage.getItem(USERS_KEY) || '[]');
                if (users.find(u => u.email === email)) return alert("Usuario ya existe");
                
                users.push({ ...newUser, uid: 'loc_u_'+Date.now() });
                localStorage.setItem(USERS_KEY, JSON.stringify(users));
                alert("Usuario autorizado localmente.");
                loadAdminUsersList(); // Refresh list
            } else {
                // Firebase: Crear registro en 'authorized_users'
                try {
                    await db.collection('authorized_users').doc(email).set(newUser);
                    // NOTA: Crear la cuenta en Auth requiere Admin SDK o funci칩n secundaria.
                    // Aqu칤 asumimos que el usuario se crear치 o usar치 una cuenta existente, 
                    // pero ya tiene permiso en la DB.
                    alert("Usuario autorizado en base de datos. (Nota: La cuenta Auth debe crearse por separado o primera vez)");
                    loadAdminUsersList();
                } catch (e) {
                    alert("Error: " + e.message);
                }
            }
            window.closeModal();
        };

        function loadAdminUsersList() {
            if (currentView !== 'admin') return;
            const container = document.getElementById('list-users-admin');
            container.innerHTML = 'Cargando...';

            let users = [];
            if (isLocalMode) {
                users = JSON.parse(localStorage.getItem(USERS_KEY) || '[]');
                renderAdminList(users);
            } else {
                db.collection('authorized_users').get().then(snap => {
                    users = snap.docs.map(d => d.data());
                    renderAdminList(users);
                });
            }
        }

        function renderAdminList(users) {
            const container = document.getElementById('list-users-admin');
            if (users.length === 0) { container.innerHTML = 'No hay usuarios.'; return; }
            
            let html = '<table><thead><tr><th>Email</th><th>Expira</th><th>D칤as Restantes</th><th>Estado</th></tr></thead><tbody>';
            const now = Date.now();
            
            users.forEach(u => {
                const days = Math.ceil((u.expiryDate - now) / (86400000));
                const status = days > 0 ? '<span class="status-badge status-success">Activo</span>' : '<span class="status-badge status-error">Vencido</span>';
                const dateStr = new Date(u.expiryDate).toLocaleDateString();
                html += `<tr>
                    <td>${u.email}</td>
                    <td>${dateStr}</td>
                    <td>${days}</td>
                    <td>${status}</td>
                </tr>`;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // --- NAVIGATION & VIEWS ---
        window.navigateTo = (viewId, element) => {
            currentView = viewId;
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${viewId}`).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            if(element) element.classList.add('active');

            const titles = { 'dashboard': 'Panel', 'clients': 'Clientes', 'projects': 'Proyectos', 'inventory': 'Inventario', 'invoices': 'Facturaci칩n', 'documents': 'Documentos', 'admin': 'Administraci칩n' };
            document.getElementById('page-title').textContent = titles[viewId];
            
            const showNewBtn = ['clients','projects','inventory','invoices','documents'].includes(viewId);
            document.getElementById('btn-new').style.display = showNewBtn ? 'block' : 'none';

            if (viewId === 'admin') loadAdminUsersList();
        };

        // --- DATA HANDLING (CRUD) ---
        function loadAllData() {
            ['clients', 'projects', 'inventory', 'invoices', 'documents'].forEach(col => loadCollection(col));
        }

        function loadCollection(colName) {
            if (isLocalMode) {
                const dbData = JSON.parse(localStorage.getItem(LOCAL_KEY) || '{}');
                const userSpace = dbData[currentUser.email] || {}; // Usar email como key para portabilidad
                const items = userSpace[colName] || [];
                renderTable(colName, items);
                updateKPI(colName, items);
            } else {
                // Path seguro: artifacts -> users -> EMAIL -> colName
                // Usamos email en vez de UID para facilitar la gesti칩n admin manual
                db.collection('artifacts').doc(APP_ID).collection('users').doc(currentUser.email).collection(colName)
                  .orderBy('createdAt', 'desc')
                  .onSnapshot((snap) => {
                      const items = snap.docs.map(d => ({id: d.id, ...d.data()}));
                      renderTable(colName, items);
                      updateKPI(colName, items);
                  });
            }
        }

        window.addItem = async (colName, data, file) => {
            if (file) {
                // Upload logic (Simplified for space)
                if(!isLocalMode) {
                    // Upload to Firebase Storage
                     try {
                        const ref = storage.ref().child(`files/${currentUser.email}/${Date.now()}_${file.name}`);
                        await ref.put(file);
                        data.fileUrl = await ref.getDownloadURL();
                     } catch(e) { console.error(e); }
                } else {
                    data.fileUrl = '#local';
                }
            }

            if (isLocalMode) {
                const dbData = JSON.parse(localStorage.getItem(LOCAL_KEY) || '{}');
                if (!dbData[currentUser.email]) dbData[currentUser.email] = {};
                if (!dbData[currentUser.email][colName]) dbData[currentUser.email][colName] = [];
                dbData[currentUser.email][colName].unshift({ id: 'loc_'+Date.now(), ...data, createdAt: Date.now() });
                localStorage.setItem(LOCAL_KEY, JSON.stringify(dbData));
                loadCollection(colName);
            } else {
                await db.collection('artifacts').doc(APP_ID).collection('users').doc(currentUser.email).collection(colName).add({
                    ...data, createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
        };

        window.deleteItem = async (colName, id) => {
            if(!confirm("쮼liminar?")) return;
            if(isLocalMode) {
                const dbData = JSON.parse(localStorage.getItem(LOCAL_KEY) || '{}');
                dbData[currentUser.email][colName] = dbData[currentUser.email][colName].filter(x => x.id !== id);
                localStorage.setItem(LOCAL_KEY, JSON.stringify(dbData));
                loadCollection(colName);
            } else {
                await db.collection('artifacts').doc(APP_ID).collection('users').doc(currentUser.email).collection(colName).doc(id).delete();
            }
        };

        // --- RENDER ---
        function renderTable(colName, items) {
            const container = document.getElementById(`list-${colName}`);
            if (!container) return;
            if (items.length === 0) { container.innerHTML = '<div style="padding:20px; color:#888;">Sin datos.</div>'; return; }
            
            let html = '<table><thead><tr>';
            schemas[colName].forEach(f => { if(f.type!=='file') html += `<th>${f.label}</th>` });
            html += '<th></th></tr></thead><tbody>';
            
            items.forEach(item => {
                html += '<tr>';
                schemas[colName].forEach(f => {
                    if(f.type!=='file') html += `<td>${item[f.id]}</td>`;
                });
                html += `<td><button style="color:red;border:none;background:none;cursor:pointer;" onclick="window.deleteItem('${colName}','${item.id}')">칑</button></td></tr>`;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function updateKPI(colName, items) {
            if (colName === 'clients') document.getElementById('kpi-clients').textContent = items.length;
            if (colName === 'projects') document.getElementById('kpi-projects').textContent = items.length;
            if (colName === 'documents') document.getElementById('kpi-documents').textContent = items.length;
            if (colName === 'invoices') {
                const total = items.reduce((acc, curr) => acc + parseFloat(curr.total||0), 0);
                document.getElementById('kpi-income').textContent = '$' + total.toLocaleString();
            }
        }

        // --- MODAL UTILS ---
        window.openCreateModal = () => {
            const fields = schemas[currentView];
            if(!fields) return;
            const container = document.getElementById('modal-fields');
            container.innerHTML = '';
            fields.forEach(f => {
                let input = f.type === 'select' 
                    ? `<select id="inp-${f.id}" class="form-input">${f.options.map(o=>`<option>${o}</option>`).join('')}</select>`
                    : `<input id="inp-${f.id}" type="${f.type}" class="form-input">`;
                container.innerHTML += `<div><label class="form-label">${f.label}</label>${input}</div>`;
            });
            document.getElementById('generic-modal').style.display = 'flex';
            document.getElementById('modal-save-btn').onclick = async () => {
                const data = {};
                let file = null;
                fields.forEach(f => {
                    const el = document.getElementById(`inp-${f.id}`);
                    if(f.type==='file') { if(el.files[0]) file = el.files[0]; }
                    else data[f.id] = el.value;
                });
                await window.addItem(currentView, data, file);
                window.closeModal();
            };
        };
        window.closeModal = () => {
            document.querySelectorAll('.modal-overlay').forEach(el => el.style.display = 'none');
        };

        initSystem();
    </script>
</body>
</html>
