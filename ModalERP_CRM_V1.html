<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entalpia | ERP & CRM Cloud</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- LIBRER√çAS FIREBASE COMPAT (Ideales para Hosting Est√°tico como GitHub Pages) -->
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-storage-compat.js"></script>

    <style>
        :root {
            --primary: #2563EB; --primary-dark: #1E40AF;
            --secondary: #64748B; --success: #10B981; --danger: #EF4444;
            --bg-body: #F3F4F6; --bg-surface: #FFFFFF; --bg-sidebar: #0F172A;
            --text-main: #111827; --text-muted: #6B7280; --text-on-dark: #F9FAFB;
            --sidebar-width: 260px; --header-height: 64px; --radius: 8px;
            --shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-body); color: var(--text-main); height: 100vh; overflow: hidden; }

        /* MODALES */
        .full-screen-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.95); display: flex; align-items: center; justify-content: center; z-index: 9999;
        }
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 500; justify-content: center; align-items: center;
        }
        .modal-box { background: white; padding: 24px; border-radius: 8px; width: 500px; max-width: 90%; }
        
        .login-card { background: white; padding: 40px; border-radius: 12px; width: 400px; text-align: center; }
        .form-input { width: 100%; padding: 12px; margin-bottom: 16px; border: 1px solid #E2E8F0; border-radius: 6px; }
        .form-label { display: block; text-align: left; margin-bottom: 5px; font-weight: 500; font-size: 0.9rem; }
        
        .btn { padding: 10px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; width: 100%; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-outline { background: white; border: 1px solid #D1D5DB; color: var(--text-main); }
        .btn-danger { background: #FEE2E2; color: var(--danger); }
        .btn-logout { background: #FEF2F2; color: var(--danger); border: 1px solid #FECACA; }
        .btn-download { background: #EFF6FF; color: var(--primary); border: 1px solid #BFDBFE; padding: 4px 10px; font-size: 0.75rem; text-decoration: none; display: inline-block; border-radius: 4px; }
        .btn-download:hover { background: #DBEAFE; }

        /* LAYOUT */
        #app-container { display: none; width: 100%; height: 100%; }
        .sidebar { width: var(--sidebar-width); background: var(--bg-sidebar); color: var(--text-on-dark); display: flex; flex-direction: column; }
        .brand { height: var(--header-height); display: flex; align-items: center; padding: 0 24px; font-weight: 700; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .nav-menu { flex: 1; padding: 20px; overflow-y: auto; }
        .nav-item { display: flex; align-items: center; padding: 12px; color: #CBD5E1; cursor: pointer; border-radius: 6px; margin-bottom: 4px; }
        .nav-item:hover, .nav-item.active { background: rgba(255,255,255,0.1); color: white; }
        .nav-item.active { background: var(--primary); }
        .nav-icon { margin-right: 12px; width: 20px; text-align: center; }
        .main-content { flex: 1; display: flex; flex-direction: column; }
        header { height: var(--header-height); background: white; border-bottom: 1px solid #E5E7EB; display: flex; justify-content: space-between; align-items: center; padding: 0 32px; }
        
        /* VISTAS */
        .view-section { display: none; height: 100%; overflow-y: auto; padding: 32px; }
        .view-section.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; } }

        /* TABLAS Y CARDS */
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 20px; }
        .card { background: white; padding: 20px; border-radius: 8px; border: 1px solid #E5E7EB; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .stat-value { font-size: 1.5rem; font-weight: 700; display: block; margin: 10px 0; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #F3F4F6; }
        th { background: #F9FAFB; color: #6B7280; font-weight: 600; }
        .status-badge { padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; font-weight: 600; }
        .status-success { background: #DEF7EC; color: #03543F; }
        
        /* WARNING BAR */
        .storage-warning { background: #FFF7ED; border: 1px solid #FED7AA; color: #C2410C; padding: 10px; border-radius: 6px; margin-bottom: 20px; font-size: 0.85rem; display: none; }

        @media (max-width: 1000px) { .grid-4 { grid-template-columns: 1fr 1fr; } .sidebar { width: 60px; } .brand span, .nav-item span:last-child { display: none; } }
    </style>
</head>
<body>

    <!-- LOADING -->
    <div id="loading-overlay" class="full-screen-modal" style="background: white; z-index: 10000; color: black;">
        <div style="text-align: center;">
            <div style="font-weight: bold; margin-bottom: 5px;">Iniciando Entalpia ERP...</div>
            <div style="font-size: 0.8rem; color: #666;">Cargando entorno seguro</div>
        </div>
    </div>

    <!-- LOGIN -->
    <div id="login-modal" class="full-screen-modal">
        <div class="login-card">
            <h2 id="login-title" style="margin-bottom: 10px;">ENTALPIA <span style="color:var(--primary)">ERP</span></h2>
            <p style="color:#666; font-size:0.9rem; margin-bottom:20px;">Acceso Corporativo Seguro</p>
            
            <form id="auth-form" onsubmit="window.handleAuth(event)">
                <input type="email" id="email" class="form-input" placeholder="usuario@empresa.com" required>
                <input type="password" id="password" class="form-input" placeholder="Contrase√±a" required>
                <button type="submit" id="login-btn-action" class="btn btn-primary">Acceder</button>
            </form>
            
            <div id="login-error" style="color: var(--danger); margin-top: 10px; font-size: 0.85rem;"></div>
            <div style="margin-top: 15px; font-size: 0.85rem; cursor: pointer; color: var(--primary);" onclick="window.toggleAuthMode()">
                <span id="toggle-auth-text">¬øNo tienes cuenta? Reg√≠strate</span>
            </div>
            <div style="margin-top: 20px; font-size: 0.75rem; color: #aaa;">Estado: <span id="system-mode">Detectando...</span></div>
        </div>
    </div>

    <!-- APP -->
    <div id="app-container">
        <aside class="sidebar">
            <div class="brand">ENTALPIA <span>ERP</span></div>
            <div class="nav-menu">
                <div class="nav-item active" onclick="window.navigateTo('dashboard', this)"><span class="nav-icon">üìä</span> <span>Dashboard</span></div>
                <div class="nav-item" onclick="window.navigateTo('clients', this)"><span class="nav-icon">üë•</span> <span>Clientes</span></div>
                <div class="nav-item" onclick="window.navigateTo('projects', this)"><span class="nav-icon">üöÄ</span> <span>Proyectos</span></div>
                <div class="nav-item" onclick="window.navigateTo('inventory', this)"><span class="nav-icon">üì¶</span> <span>Inventario</span></div>
                <div class="nav-item" onclick="window.navigateTo('invoices', this)"><span class="nav-icon">üí≥</span> <span>Facturas</span></div>
                <div class="nav-item" onclick="window.navigateTo('documents', this)"><span class="nav-icon">üìÑ</span> <span>Documentos</span></div>
            </div>
            <div style="padding: 20px; border-top: 1px solid rgba(255,255,255,0.1); cursor: pointer;" onclick="window.handleLogout()">
                <div style="font-size: 0.8rem; opacity: 0.7;">Usuario Conectado</div>
                <div id="user-email-display" style="font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">...</div>
            </div>
        </aside>

        <main class="main-content">
            <header>
                <h2 id="page-title">Panel de Control</h2>
                <div style="display: flex; gap: 10px;">
                    <!-- Bot√≥n Salir redirige al index del repositorio -->
                    <button class="btn btn-logout" onclick="window.handleLogout()">Salir</button>
                    <button id="btn-new" class="btn btn-primary" style="display: none;" onclick="window.openCreateModal()">+ Nuevo</button>
                </div>
            </header>

            <!-- VISTAS -->
            <div id="view-dashboard" class="view-section active">
                <div id="local-warning" class="storage-warning">
                    ‚ö†Ô∏è <strong>Modo Local:</strong> Est√°s usando el almacenamiento temporal del navegador. Para activar los 10GB en GitHub Pages, edita el c√≥digo e inserta tu <code>firebaseConfig</code>.
                </div>

                <div class="grid-4">
                    <div class="card"><span style="color:#666">Ingresos</span><span class="stat-value" id="kpi-income">$0</span></div>
                    <div class="card"><span style="color:#666">Proyectos</span><span class="stat-value" id="kpi-projects">0</span></div>
                    <div class="card"><span style="color:#666">Clientes</span><span class="stat-value" id="kpi-clients">0</span></div>
                    <div class="card"><span style="color:#666">Docs</span><span class="stat-value" id="kpi-documents">0</span></div>
                </div>
                <div class="card">
                    <h3>Bienvenido a Entalpia</h3>
                    <p style="color:#666; margin-top:5px;">Plataforma de gesti√≥n de recursos corporativos.</p>
                </div>
            </div>

            <div id="view-clients" class="view-section">
                <div class="card"><h3>Directorio de Clientes</h3><div id="list-clients"></div></div>
            </div>
            <div id="view-projects" class="view-section">
                <div class="card"><h3>Proyectos Activos</h3><div id="list-projects"></div></div>
            </div>
            <div id="view-inventory" class="view-section">
                <div class="card"><h3>Inventario</h3><div id="list-inventory"></div></div>
            </div>
            <div id="view-invoices" class="view-section">
                <div class="card"><h3>Facturaci√≥n</h3><div id="list-invoices"></div></div>
            </div>
            
            <!-- Vista de Documentos -->
            <div id="view-documents" class="view-section">
                <div class="card">
                    <h3>Gesti√≥n Documental (Cloud)</h3>
                    <p style="font-size:0.8rem; color:#666; margin-bottom:15px;">Sube contratos, facturas y evidencias.</p>
                    <div id="list-documents"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- MODAL GEN√âRICO -->
    <div id="generic-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 id="modal-title" style="margin-bottom: 20px;">Nuevo Registro</h3>
            <div id="modal-fields"></div>
            
            <div id="upload-progress-container" style="display:none; margin-top:15px;">
                <div style="font-size:0.8rem; margin-bottom:5px;">Subiendo archivo...</div>
                <div style="width:100%; background:#eee; height:6px; border-radius:3px;">
                    <div id="upload-bar" style="width:0%; background:var(--primary); height:100%; border-radius:3px; transition:width 0.3s;"></div>
                </div>
            </div>

            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                <button class="btn btn-outline" onclick="window.closeModal()">Cancelar</button>
                <button class="btn btn-primary" id="modal-save-btn">Guardar</button>
            </div>
        </div>
    </div>

    <!-- L√ìGICA DEL SISTEMA -->
    <script>
        // --- CONFIGURACI√ìN PARA GITHUB PAGES ---
        // IMPORTANTE: Para que funcione en tu p√°gina web con almacenamiento real,
        // reemplaza el objeto vac√≠o abajo con tu configuraci√≥n de Firebase Console.
        const MANUAL_FIREBASE_CONFIG = {
            // apiKey: "TU_API_KEY",
            // authDomain: "TU_PROYECTO.firebaseapp.com",
            // projectId: "TU_PROYECTO",
            // storageBucket: "TU_PROYECTO.appspot.com",
            // messagingSenderId: "...",
            // appId: "..."
        };

        // --- ESTADO Y VARIABLES ---
        let db, auth, storage;
        let isLocalMode = false;
        let currentUser = null;
        let isRegistering = false;
        let currentView = 'dashboard';
        const LOCAL_KEY = 'entalpia_db_v3';
        const APP_ID = 'entalpia_app_v1';

        // --- DEFINICI√ìN DE CAMPOS ---
        const schemas = {
            'clients': [
                { id: 'name', label: 'Nombre', type: 'text' },
                { id: 'company', label: 'Empresa', type: 'text' },
                { id: 'email', label: 'Email', type: 'email' }
            ],
            'projects': [
                { id: 'name', label: 'Proyecto', type: 'text' },
                { id: 'client', label: 'Cliente', type: 'text' },
                { id: 'status', label: 'Estado', type: 'select', options: ['Activo', 'Pendiente', 'Finalizado'] }
            ],
            'inventory': [
                { id: 'product', label: 'Producto', type: 'text' },
                { id: 'stock', label: 'Stock', type: 'number' },
                { id: 'price', label: 'Precio', type: 'number' }
            ],
            'invoices': [
                { id: 'number', label: 'N¬∞ Factura', type: 'text' },
                { id: 'client', label: 'Cliente', type: 'text' },
                { id: 'total', label: 'Total', type: 'number' }
            ],
            'documents': [
                { id: 'name', label: 'Nombre del Archivo', type: 'text' },
                { id: 'type', label: 'Tipo', type: 'select', options: ['Contrato', 'Factura', 'Reporte', 'Otro'] },
                { id: 'file', label: 'Adjuntar Archivo', type: 'file' }
            ]
        };

        // --- INICIALIZACI√ìN INTELIGENTE ---
        function initSystem() {
            try {
                let config = null;

                // 1. Intentar usar la config manual (prioridad para GitHub Pages)
                if (MANUAL_FIREBASE_CONFIG.apiKey) {
                    config = MANUAL_FIREBASE_CONFIG;
                } 
                // 2. Intentar usar la config inyectada por IA (entorno de desarrollo)
                else if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                    config = JSON.parse(__firebase_config);
                }

                if (config) {
                    // Inicializar Firebase Real
                    if (!firebase.apps.length) {
                        firebase.initializeApp(config);
                    }
                    auth = firebase.auth();
                    db = firebase.firestore();
                    storage = firebase.storage();
                    
                    document.getElementById('system-mode').textContent = "Nube (10GB)";
                    document.getElementById('system-mode').style.color = "green";
                    
                    auth.onAuthStateChanged(handleSession);
                } else {
                    throw new Error("Sin configuraci√≥n");
                }
            } catch (e) {
                // Fallback a Modo Local
                console.log("Activando Modo Local (Offline) - Raz√≥n:", e.message);
                isLocalMode = true;
                document.getElementById('system-mode').textContent = "Local (Demo)";
                document.getElementById('system-mode').style.color = "orange";
                document.getElementById('local-warning').style.display = 'block';
                
                const storedUser = sessionStorage.getItem('entalpia_user');
                handleSession(storedUser ? JSON.parse(storedUser) : null);
            }
        }

        function handleSession(user) {
            document.getElementById('loading-overlay').style.display = 'none';
            if (user) {
                currentUser = user;
                document.getElementById('user-email-display').textContent = user.email;
                document.getElementById('login-modal').style.display = 'none';
                document.getElementById('app-container').style.display = 'flex';
                loadAllData();
            } else {
                currentUser = null;
                document.getElementById('app-container').style.display = 'none';
                document.getElementById('login-modal').style.display = 'flex';
            }
        }

        // --- FUNCIONES DE VENTANA ---
        window.handleAuth = async (e) => {
            if(e) e.preventDefault();
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            const errorDiv = document.getElementById('login-error');
            
            if (!email || !pass) return errorDiv.textContent = "Completa todos los campos";
            errorDiv.textContent = "Procesando...";

            if (isLocalMode) {
                // Simulaci√≥n Local
                setTimeout(() => {
                    const users = JSON.parse(localStorage.getItem('entalpia_users') || '[]');
                    const existing = users.find(u => u.email === email);
                    
                    if (isRegistering) {
                        if (existing) errorDiv.textContent = "El usuario ya existe.";
                        else {
                            const newUser = { uid: 'loc_' + Date.now(), email, pass };
                            users.push(newUser);
                            localStorage.setItem('entalpia_users', JSON.stringify(users));
                            sessionStorage.setItem('entalpia_user', JSON.stringify(newUser));
                            handleSession(newUser);
                        }
                    } else {
                        if (existing && existing.pass === pass) {
                            sessionStorage.setItem('entalpia_user', JSON.stringify(existing));
                            handleSession(existing);
                        } else {
                            errorDiv.textContent = "Credenciales incorrectas.";
                        }
                    }
                }, 800);
            } else {
                // Firebase Real
                try {
                    if (isRegistering) await auth.createUserWithEmailAndPassword(email, pass);
                    else await auth.signInWithEmailAndPassword(email, pass);
                } catch (err) {
                    errorDiv.textContent = "Error: " + err.message;
                }
            }
        };

        window.handleLogout = async () => {
            if (isLocalMode) sessionStorage.removeItem('entalpia_user');
            else try { await auth.signOut(); } catch(e){}
            // Redirige al index.html del repositorio/carpeta actual
            window.location.href = 'index.html'; 
        };

        window.toggleAuthMode = () => {
            isRegistering = !isRegistering;
            const btn = document.getElementById('login-btn-action');
            const txt = document.getElementById('toggle-auth-text');
            const title = document.getElementById('login-title');
            
            if (isRegistering) {
                title.innerHTML = "Crear Cuenta";
                btn.textContent = "Registrarme";
                txt.textContent = "¬øYa tienes cuenta? Inicia Sesi√≥n";
            } else {
                title.innerHTML = 'ENTALPIA <span style="color:var(--primary)">ERP</span>';
                btn.textContent = "Acceder";
                txt.textContent = "¬øNo tienes cuenta? Reg√≠strate";
            }
        };

        window.navigateTo = (viewId, element) => {
            currentView = viewId;
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${viewId}`).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            if(element) element.classList.add('active');

            const titles = { 
                'dashboard': 'Panel', 'clients': 'Clientes', 'projects': 'Proyectos', 
                'inventory': 'Inventario', 'invoices': 'Facturaci√≥n', 'documents': 'Documentos'
            };
            document.getElementById('page-title').textContent = titles[viewId];
            document.getElementById('btn-new').style.display = viewId === 'dashboard' ? 'none' : 'block';
        };

        // --- GESTI√ìN DE DATOS ---
        function loadAllData() {
            ['clients', 'projects', 'inventory', 'invoices', 'documents'].forEach(col => loadCollection(col));
        }

        function loadCollection(colName) {
            if (isLocalMode) {
                const dbData = JSON.parse(localStorage.getItem(LOCAL_KEY) || '{}');
                const userSpace = dbData[currentUser.uid] || {};
                const items = userSpace[colName] || [];
                renderTable(colName, items);
                updateKPI(colName, items);
            } else {
                db.collection('artifacts').doc(APP_ID).collection('users').doc(currentUser.uid).collection(colName)
                  .orderBy('createdAt', 'desc')
                  .onSnapshot((snap) => {
                      const items = snap.docs.map(d => ({id: d.id, ...d.data()}));
                      renderTable(colName, items);
                      updateKPI(colName, items);
                  });
            }
        }

        window.addItem = async (colName, data, file) => {
            // Manejo de Archivos
            if (file) {
                document.getElementById('upload-progress-container').style.display = 'block';
                document.getElementById('upload-bar').style.width = '30%'; 
                
                if (isLocalMode) {
                    data.fileUrl = '#'; 
                    data.fileName = file.name;
                    alert("‚ö†Ô∏è Modo GitHub/Local: Configura la variable MANUAL_FIREBASE_CONFIG en el c√≥digo para subir archivos reales.");
                    document.getElementById('upload-bar').style.width = '100%';
                } else {
                    try {
                        const storageRef = storage.ref().child(`artifacts/${APP_ID}/users/${currentUser.uid}/files/${Date.now()}_${file.name}`);
                        await storageRef.put(file);
                        const url = await storageRef.getDownloadURL();
                        
                        data.fileUrl = url;
                        data.fileName = file.name;
                        data.fileSize = (file.size / 1024 / 1024).toFixed(2) + ' MB';
                        document.getElementById('upload-bar').style.width = '100%';
                    } catch (error) {
                        alert("Error subiendo: " + error.message);
                        return;
                    }
                }
            }

            // Guardado de Datos
            if (isLocalMode) {
                const dbData = JSON.parse(localStorage.getItem(LOCAL_KEY) || '{}');
                if (!dbData[currentUser.uid]) dbData[currentUser.uid] = {};
                if (!dbData[currentUser.uid][colName]) dbData[currentUser.uid][colName] = [];
                
                dbData[currentUser.uid][colName].unshift({ id: 'loc_item_'+Date.now(), ...data, createdAt: Date.now() });
                localStorage.setItem(LOCAL_KEY, JSON.stringify(dbData));
                loadCollection(colName);
            } else {
                await db.collection('artifacts').doc(APP_ID).collection('users').doc(currentUser.uid).collection(colName).add({
                    ...data,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
            
            document.getElementById('upload-progress-container').style.display = 'none';
        };

        window.deleteItem = async (colName, id) => {
            if(!confirm("¬øEliminar registro?")) return;
            if(isLocalMode) {
                const dbData = JSON.parse(localStorage.getItem(LOCAL_KEY) || '{}');
                const list = dbData[currentUser.uid][colName];
                dbData[currentUser.uid][colName] = list.filter(x => x.id !== id);
                localStorage.setItem(LOCAL_KEY, JSON.stringify(dbData));
                loadCollection(colName);
            } else {
                await db.collection('artifacts').doc(APP_ID).collection('users').doc(currentUser.uid).collection(colName).doc(id).delete();
            }
        };

        // --- RENDERIZADO ---
        function renderTable(colName, items) {
            const container = document.getElementById(`list-${colName}`);
            if (!container) return; 
            
            if (items.length === 0) {
                container.innerHTML = '<div style="padding:20px; color:#888; text-align:center;">No hay registros.</div>';
                return;
            }

            let html = '<table><thead><tr>';
            schemas[colName].forEach(f => { if (f.type !== 'file') html += `<th>${f.label}</th>`; });
            if (colName === 'documents') html += `<th>Archivo</th>`;
            html += '<th>Acci√≥n</th></tr></thead><tbody>';

            items.forEach(item => {
                html += '<tr>';
                schemas[colName].forEach(f => {
                    if (f.type !== 'file') {
                        let val = item[f.id];
                        if(f.type === 'number') val = (colName === 'invoices' || colName === 'inventory') && f.id !== 'stock' ? '$'+val : val;
                        if(f.id === 'status') val = `<span class="status-badge status-success">${val}</span>`;
                        html += `<td>${val}</td>`;
                    }
                });
                if (colName === 'documents') {
                    html += item.fileUrl && item.fileUrl !== '#' 
                        ? `<td><a href="${item.fileUrl}" target="_blank" class="btn-download">‚¨á Abrir</a></td>`
                        : `<td><span style="color:#aaa; font-size:0.8rem;">Local</span></td>`;
                }
                html += `<td><button style="color:red; background:none; border:none; cursor:pointer;" onclick="window.deleteItem('${colName}', '${item.id}')">Eliminar</button></td></tr>`;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function updateKPI(colName, items) {
            if(colName === 'invoices') {
                const total = items.reduce((sum, i) => sum + parseFloat(i.total||0), 0);
                document.getElementById('kpi-income').textContent = '$' + total.toLocaleString();
            }
            if(colName === 'projects') document.getElementById('kpi-projects').textContent = items.length;
            if(colName === 'clients') document.getElementById('kpi-clients').textContent = items.length;
            if(colName === 'documents') document.getElementById('kpi-documents').textContent = items.length;
        }

        // --- MODAL ---
        window.openCreateModal = () => {
            const fields = schemas[currentView];
            if(!fields) return;
            
            const container = document.getElementById('modal-fields');
            container.innerHTML = '';
            
            fields.forEach(f => {
                let input;
                if(f.type === 'select') input = `<select id="inp-${f.id}" class="form-input">${f.options.map(o => `<option value="${o}">${o}</option>`).join('')}</select>`;
                else if (f.type === 'file') input = `<input id="inp-${f.id}" type="file" class="form-input">`;
                else input = `<input id="inp-${f.id}" type="${f.type}" class="form-input" placeholder="${f.label}">`;
                container.innerHTML += `<div><label class="form-label">${f.label}</label>${input}</div>`;
            });
            
            document.getElementById('generic-modal').style.display = 'flex';
            document.getElementById('upload-progress-container').style.display = 'none';
            document.getElementById('upload-bar').style.width = '0%';
            
            document.getElementById('modal-save-btn').onclick = async () => {
                const data = {};
                let file = null;
                let valid = true;
                
                fields.forEach(f => {
                    const el = document.getElementById(`inp-${f.id}`);
                    if (f.type === 'file') { if (el.files.length > 0) file = el.files[0]; }
                    else {
                        const val = el.value;
                        if(!val) valid = false;
                        data[f.id] = val;
                    }
                });

                if(!valid) return alert("Completa los campos de texto");
                const btn = document.getElementById('modal-save-btn');
                btn.disabled = true; btn.textContent = "Guardando...";
                await window.addItem(currentView, data, file);
                btn.disabled = false; btn.textContent = "Guardar";
                window.closeModal();
            };
        };

        window.closeModal = () => document.getElementById('generic-modal').style.display = 'none';

        initSystem();
    </script>
</body>
</html>
