import React, { useState, useEffect } from 'react';
import { Plus, Trash2, FileText, RefreshCw, CheckCircle, XCircle, Info, Printer, BookOpen, MinusCircle, Ruler, Hammer, Volume2, StopCircle } from 'lucide-react';

const checklistItems = [
  { id: 'alturaSuperior', label: 'Abertura Superior inicia a > 180cm del piso (4.1.2.a).' },
  { id: 'alturaInferior', label: 'Abertura Inferior inicia a < 30cm del piso (4.1.2.a).' },
  { id: 'proteccionRejilla', label: 'Rejillas/Celosías limpias y dimensión menor > 8mm.' },
  { id: 'noDuctoUnico', label: 'Ductos independientes (No usar ducto único vertical).' },
  { id: 'pendienteHorizontal', label: 'Conductos horizontales sin pendiente negativa (4.2.1.c).' },
];

const grilleTypes = [
  { label: 'Rejilla Metálica / Troquelada (Estándar)', factor: 0.60 },
  { label: 'Rejilla de Madera / Celosía', factor: 0.35 },
  { label: 'Malla de Alambre (Mosquitero)', factor: 0.90 },
  { label: 'Ventana Basculante (Abierta)', factor: 0.80 },
  { label: 'Personalizado', factor: 1.0 },
];

const App = () => {
  // --- Estados Principales ---
  const [projectInfo, setProjectInfo] = useState({
    inspector: '',
    fecha: new Date().toISOString().split('T')[0],
    direccion: '',
    ciudad: '',
    ubicacionRecinto: ''
  });

  const [appliances, setAppliances] = useState([
    { id: 1, name: 'Estufa Doméstica', kw: 8.0 },
    { id: 2, name: 'Calentador de Agua', kw: 11.0 }
  ]);

  const [roomDims, setRoomDims] = useState({ largo: 0, ancho: 0, alto: 2.4 });
  
  const [ventMethod, setVentMethod] = useState('4.1.2'); // Default: Comunicación Espacios Interiores
  
  const [openings, setOpenings] = useState([
    { id: 1, type: 'Superior', width: 20, height: 20, qty: 1, freeAreaFactor: 0.7 },
    { id: 2, type: 'Inferior', width: 20, height: 20, qty: 1, freeAreaFactor: 0.7 }
  ]);

  // Estados del checklist
  const [checklist, setChecklist] = useState({
    alturaSuperior: 'no',
    alturaInferior: 'no',
    proteccionRejilla: 'no',
    noDuctoUnico: 'no',
    pendienteHorizontal: 'no'
  });

  const [showModal, setShowModal] = useState(false);
  const [isSpeaking, setIsSpeaking] = useState(false);

  // Estados para la Calculadora de Construcción
  const [calcWidth, setCalcWidth] = useState(20);
  const [calcGrilleType, setCalcGrilleType] = useState(0.60);

  // --- Lógica del Asistente de Voz ---
  const explanationText = `
    Hola. Bienvenido a la guía técnica de la norma N T C 36 31.
    El objetivo de esta inspección es asegurar que los artefactos a gas tengan suficiente aire para una combustión segura y evitar la acumulación de monóxido de carbono.
    
    Te explico cómo funciona:
    Primero, evaluamos el volumen. Si el recinto tiene menos de 3.4 metros cúbicos de aire por cada kilovatio de potencia instalada, se considera un recinto "Confinado". Esto es peligroso si no se ventila adecuadamente.
    
    Segundo, si el recinto es confinado, debemos instalar aberturas permanentes.
    Si tomas aire del interior de otro cuarto, necesitas dos rejillas: una ubicada en la zona superior y otra en la inferior.
    Si tomas aire del exterior, el tamaño depende de si el conducto es vertical u horizontal.
    
    Usa esta herramienta para sumar la potencia de los equipos y dimensionar las rejillas para que cumplan con el área libre requerida.
  `;

  const toggleSpeech = () => {
    if (isSpeaking) {
      window.speechSynthesis.cancel();
      setIsSpeaking(false);
    } else {
      const utterance = new SpeechSynthesisUtterance(explanationText);
      const voices = window.speechSynthesis.getVoices();
      const spanishVoice = voices.find(voice => voice.lang.includes('es'));
      if (spanishVoice) utterance.voice = spanishVoice;
      
      utterance.lang = 'es-ES';
      utterance.rate = 1.0;
      utterance.onend = () => setIsSpeaking(false);
      
      window.speechSynthesis.speak(utterance);
      setIsSpeaking(true);
    }
  };

  useEffect(() => {
    return () => window.speechSynthesis.cancel();
  }, []);

  // --- Cálculos ---

  // 1. Potencia Total Agregada (Qt)
  const totalKW = appliances.reduce((acc, curr) => acc + parseFloat(curr.kw || 0), 0);

  // 2. Volumen del Recinto
  const roomVol = (parseFloat(roomDims.largo) * parseFloat(roomDims.ancho) * parseFloat(roomDims.alto)).toFixed(2);
  const reqVolStandard = (totalKW * 3.4).toFixed(2);
  const isConfined = parseFloat(roomVol) < parseFloat(reqVolStandard);

  // 3. Requerimientos de Ventilación
  const calculateRequirements = () => {
    let reqAreaCm2 = 0;
    let methodDesc = "";

    switch (ventMethod) {
      case '4.1.2': // Interior
        reqAreaCm2 = Math.max(645, totalKW * 22);
        methodDesc = "Aire del Interior (NTC 3631 4.1.2)";
        break;
      case '4.2.1a': // Exterior Directo/Vertical
        reqAreaCm2 = totalKW * 6;
        methodDesc = "Exterior Directo/Vertical (NTC 3631 4.2.1a)";
        break;
      case '4.2.1b': // Exterior Horizontal
        reqAreaCm2 = totalKW * 11;
        methodDesc = "Exterior Horizontal (NTC 3631 4.2.1b)";
        break;
      default:
        reqAreaCm2 = 0;
    }
    return { reqAreaCm2, methodDesc };
  };

  const { reqAreaCm2, methodDesc } = calculateRequirements();

  // 4. Área Libre Real Instalada
  const actualFreeArea = openings.reduce((acc, curr) => {
    const area = (curr.width * curr.height * curr.qty * curr.freeAreaFactor);
    return acc + area;
  }, 0);

  // 5. Resultado Global
  const meetsVolume = !isConfined;
  const meetsVentilation = actualFreeArea >= reqAreaCm2;
  const checklistPass = Object.values(checklist).every(val => val === 'ok' || val === 'na');
  const globalStatus = meetsVolume ? true : (meetsVentilation && checklistPass);

  // --- Cálculos Constructor ---
  const calcRequiredHeight = (reqAreaCm2 / calcGrilleType / calcWidth) || 0;
  const calcPhysicalArea = (reqAreaCm2 / calcGrilleType) || 0;

  // --- Manejadores ---

  const handleApplianceChange = (id, field, value) => {
    setAppliances(appliances.map(app => app.id === id ? { ...app, [field]: value } : app));
  };

  const addAppliance = () => {
    setAppliances([...appliances, { id: Date.now(), name: '', kw: 0 }]);
  };

  const removeAppliance = (id) => {
    setAppliances(appliances.filter(app => app.id !== id));
  };

  const handleOpeningChange = (id, field, value) => {
    setOpenings(openings.map(op => op.id === id ? { ...op, [field]: value } : op));
  };

  const handleChecklistChange = (id, status) => {
    setChecklist(prev => ({
      ...prev,
      [id]: prev[id] === status ? 'no' : status
    }));
  };

  const handleReset = () => {
    if(window.confirm("¿Estás seguro de borrar todos los datos?")) {
      setAppliances([{ id: 1, name: 'Artefacto 1', kw: 0 }]);
      setRoomDims({ largo: 0, ancho: 0, alto: 2.4 });
      setOpenings([{ id: 1, type: 'Superior', width: 0, height: 0, qty: 1, freeAreaFactor: 0.7 }]);
      setChecklist({
        alturaSuperior: 'no',
        alturaInferior: 'no',
        proteccionRejilla: 'no',
        noDuctoUnico: 'no',
        pendienteHorizontal: 'no'
      });
      setIsSpeaking(false);
      window.speechSynthesis.cancel();
    }
  };

  const handlePrint = () => {
    window.print();
  };

  // --- Interfaz ---

  return (
    <div className="min-h-screen bg-gray-100 p-4 font-sans text-gray-800 print:bg-white print:p-0">
      
      {/* Header - No Print */}
      <div className="max-w-4xl mx-auto mb-6 flex flex-col md:flex-row justify-between items-center print:hidden gap-4">
        
        {/* Title Area */}
        <div>
          <h1 className="text-2xl font-bold text-blue-800">Evaluación NTC 3631</h1>
          <p className="text-sm text-gray-600">Herramienta para inspectores y técnicos</p>
        </div>

        {/* Toolbar */}
        <div className="flex flex-wrap gap-2 justify-center">
          <button 
            onClick={toggleSpeech}
            className={`flex items-center gap-2 px-4 py-2 text-white rounded shadow transition-all ${isSpeaking ? 'bg-red-500 hover:bg-red-600' : 'bg-orange-500 hover:bg-orange-600'}`}
          >
            {isSpeaking ? <StopCircle size={18} /> : <Volume2 size={18} />} 
            {isSpeaking ? 'Detener' : 'Explicar Tema'}
          </button>

          <button 
            onClick={() => setShowModal(true)}
            className="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 transition"
          >
            <BookOpen size={18} /> Referencia Normativa
          </button>
          <button 
            onClick={handleReset}
            className="flex items-center gap-2 px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 transition"
          >
            <RefreshCw size={18} /> Limpiar
          </button>
          <button 
            onClick={handlePrint}
            className="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition"
          >
            <Printer size={18} /> Descargar PDF
          </button>
        </div>
      </div>

      {/* Main Content */}
      <div className="max-w-4xl mx-auto bg-white shadow-lg rounded-lg overflow-hidden print:shadow-none print:w-full print:max-w-none">
        
        {/* Report Header */}
        <div className="bg-blue-900 text-white p-6 print:bg-white print:text-black print:border-b-2 print:border-black">
          <div className="flex justify-between items-start">
            <div>
              <h2 className="text-2xl font-bold mb-1 print:text-3xl">Informe de Ventilación</h2>
              <p className="opacity-80 print:opacity-100">Evaluación de conformidad según NTC 3631</p>
            </div>
            <div className="text-right text-sm print:text-base">
              <p>Fecha: {projectInfo.fecha}</p>
              <p>ID Inspección: {Math.floor(Math.random() * 10000)}</p>
            </div>
          </div>
        </div>

        <div className="p-6 grid gap-6">
          
          {/* Section 1: Info General */}
          <section className="border rounded-lg p-4 bg-gray-50 print:bg-white print:border-gray-300">
            <h3 className="font-bold text-lg mb-3 border-b pb-1 text-blue-800">1. Información del Sitio</h3>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label className="block text-xs font-semibold text-gray-500 uppercase">Inspector/Técnico</label>
                <input 
                  type="text" 
                  className="w-full border-b border-gray-300 bg-transparent py-1 focus:outline-none focus:border-blue-500"
                  value={projectInfo.inspector}
                  onChange={(e) => setProjectInfo({...projectInfo, inspector: e.target.value})}
                  placeholder="Nombre del responsable"
                />
              </div>
              <div>
                <label className="block text-xs font-semibold text-gray-500 uppercase">Ciudad</label>
                <input 
                  type="text" 
                  className="w-full border-b border-gray-300 bg-transparent py-1 focus:outline-none focus:border-blue-500"
                  value={projectInfo.ciudad}
                  onChange={(e) => setProjectInfo({...projectInfo, ciudad: e.target.value})}
                  placeholder="Ciudad"
                />
              </div>
              <div className="md:col-span-2">
                <label className="block text-xs font-semibold text-gray-500 uppercase">Dirección / Recinto</label>
                <input 
                  type="text" 
                  className="w-full border-b border-gray-300 bg-transparent py-1 focus:outline-none focus:border-blue-500"
                  value={projectInfo.direccion}
                  onChange={(e) => setProjectInfo({...projectInfo, direccion: e.target.value})}
                  placeholder="Dirección y ubicación específica (ej. Cocina, Patio)"
                />
              </div>
            </div>
          </section>

          {/* Section 2: Artefactos */}
          <section className="border rounded-lg p-4 bg-white print:border-gray-300">
             <div className="flex justify-between items-center mb-3 border-b pb-1">
                <h3 className="font-bold text-lg text-blue-800">2. Artefactos a Gas (Carga)</h3>
                <button onClick={addAppliance} className="text-blue-600 hover:text-blue-800 print:hidden">
                  <Plus size={20} />
                </button>
             </div>
             
             <table className="w-full text-sm text-left">
               <thead>
                 <tr className="bg-gray-100 text-gray-600">
                   <th className="p-2 rounded-l">Artefacto</th>
                   <th className="p-2 w-32">Potencia (kW)</th>
                   <th className="p-2 w-10 print:hidden"></th>
                 </tr>
               </thead>
               <tbody>
                 {appliances.map((app) => (
                   <tr key={app.id} className="border-b">
                     <td className="p-2">
                       <input 
                         type="text" 
                         value={app.name} 
                         onChange={(e) => handleApplianceChange(app.id, 'name', e.target.value)}
                         className="w-full bg-transparent focus:outline-none"
                         placeholder="Ej. Estufa"
                       />
                     </td>
                     <td className="p-2">
                        <input 
                         type="number" 
                         value={app.kw} 
                         onChange={(e) => handleApplianceChange(app.id, 'kw', e.target.value)}
                         className="w-full bg-transparent focus:outline-none font-mono"
                       />
                     </td>
                     <td className="p-2 text-center print:hidden">
                        {appliances.length > 1 && (
                          <button onClick={() => removeAppliance(app.id)} className="text-red-400 hover:text-red-600">
                            <Trash2 size={16} />
                          </button>
                        )}
                     </td>
                   </tr>
                 ))}
               </tbody>
               <tfoot>
                 <tr className="font-bold bg-blue-50">
                   <td className="p-2 text-right">Potencia Conjunta Total:</td>
                   <td className="p-2 text-blue-800 font-mono">{totalKW.toFixed(2)} kW</td>
                   <td className="print:hidden"></td>
                 </tr>
               </tfoot>
             </table>
          </section>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            
            {/* Section 3: Volumen */}
            <section className="border rounded-lg p-4 bg-white print:border-gray-300">
              <h3 className="font-bold text-lg mb-3 border-b pb-1 text-blue-800">3. Análisis de Volumen</h3>
              <div className="flex gap-2 mb-4">
                 <div className="flex-1">
                    <label className="block text-xs text-gray-500">Largo (m)</label>
                    <input type="number" value={roomDims.largo} onChange={e=>setRoomDims({...roomDims, largo: e.target.value})} className="w-full border p-1 rounded font-mono text-center" />
                 </div>
                 <div className="flex-1">
                    <label className="block text-xs text-gray-500">Ancho (m)</label>
                    <input type="number" value={roomDims.ancho} onChange={e=>setRoomDims({...roomDims, ancho: e.target.value})} className="w-full border p-1 rounded font-mono text-center" />
                 </div>
                 <div className="flex-1">
                    <label className="block text-xs text-gray-500">Alto (m)</label>
                    <input type="number" value={roomDims.alto} onChange={e=>setRoomDims({...roomDims, alto: e.target.value})} className="w-full border p-1 rounded font-mono text-center" />
                 </div>
              </div>

              <div className="bg-gray-100 p-3 rounded text-sm space-y-2">
                <div className="flex justify-between">
                  <span>Volumen Real:</span>
                  <span className="font-bold">{roomVol} m³</span>
                </div>
                <div className="flex justify-between text-gray-600">
                  <span>Volumen Requerido (3.4 m³/kW):</span>
                  <span>{reqVolStandard} m³</span>
                </div>
                <div className={`mt-2 p-2 rounded text-center font-bold ${isConfined ? 'bg-orange-100 text-orange-700' : 'bg-green-100 text-green-700'}`}>
                  {isConfined ? 'RECINTO CONFINADO' : 'RECINTO NO CONFINADO'}
                </div>
              </div>
            </section>

            {/* Section 4: Aberturas Existentes */}
            <section className="border rounded-lg p-4 bg-white print:border-gray-300">
              <h3 className="font-bold text-lg mb-3 border-b pb-1 text-blue-800">4. Evaluación de Aberturas</h3>
              
              <div className="mb-3">
                <label className="block text-xs font-semibold text-gray-500 mb-1">Método de Ventilación</label>
                <select 
                  value={ventMethod} 
                  onChange={(e) => setVentMethod(e.target.value)}
                  className="w-full border rounded p-1 text-sm bg-white"
                >
                  <option value="4.1.2">Combinación Espacios (4.1.2)</option>
                  <option value="4.2.1a">Exterior - Vertical/Directo (4.2.1a)</option>
                  <option value="4.2.1b">Exterior - Horizontal (4.2.1b)</option>
                </select>
              </div>

              <div className="space-y-3">
                {openings.map((op, idx) => (
                   <div key={op.id} className="flex gap-2 items-end border-b pb-2">
                      <div className="w-20">
                         <label className="text-[10px] text-gray-500">Tipo</label>
                         <div className="text-xs font-bold">{op.type}</div>
                      </div>
                      <div className="flex-1">
                         <label className="text-[10px] text-gray-500">Ancho x Alto (cm)</label>
                         <div className="flex items-center gap-1">
                            <input type="number" className="w-full border rounded p-1 text-xs" value={op.width} onChange={e => handleOpeningChange(op.id, 'width', e.target.value)} />
                            <span className="text-gray-400">x</span>
                            <input type="number" className="w-full border rounded p-1 text-xs" value={op.height} onChange={e => handleOpeningChange(op.id, 'height', e.target.value)} />
                         </div>
                      </div>
                      <div className="w-16">
                         <label className="text-[10px] text-gray-500">Factor</label>
                         <input type="number" step="0.1" className="w-full border rounded p-1 text-xs" value={op.freeAreaFactor} onChange={e => handleOpeningChange(op.id, 'freeAreaFactor', e.target.value)} />
                      </div>
                   </div>
                ))}
              </div>
              
              <div className="mt-3 flex justify-between items-center text-sm font-bold bg-blue-50 p-2 rounded">
                 <span>Área Libre Total:</span>
                 <span>{actualFreeArea.toFixed(0)} cm²</span>
              </div>
            </section>
          </div>

          {/* Section 5: Calculadora para Técnicos (New) */}
          <section className="border-2 border-dashed border-indigo-300 rounded-lg p-4 bg-indigo-50 print:break-inside-avoid">
             <div className="flex items-center gap-2 mb-3 border-b border-indigo-200 pb-2">
                <Hammer className="text-indigo-600" size={20} />
                <h3 className="font-bold text-lg text-indigo-800">Herramienta de Dimensionamiento (Técnicos)</h3>
             </div>
             
             <p className="text-sm text-gray-600 mb-4">
               Si el recinto es confinado, use esta herramienta para calcular el tamaño real del hueco que debe realizar en la pared.
             </p>

             <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                   <label className="block text-xs font-bold text-gray-500 mb-1">1. Área Libre Requerida (Sugerida)</label>
                   <div className="flex items-center gap-2">
                     <input disabled value={reqAreaCm2.toFixed(0)} className="w-full bg-white border border-gray-300 rounded p-2 text-gray-500 font-mono" />
                     <span className="text-xs text-gray-400">cm²</span>
                   </div>
                </div>

                <div>
                   <label className="block text-xs font-bold text-gray-500 mb-1">2. Tipo de Rejilla (Factor)</label>
                   <select 
                      className="w-full border border-gray-300 rounded p-2 text-sm bg-white"
                      value={calcGrilleType}
                      onChange={(e) => setCalcGrilleType(parseFloat(e.target.value))}
                   >
                      {grilleTypes.map((g, i) => (
                        <option key={i} value={g.factor}>{g.label} ({g.factor * 100}%)</option>
                      ))}
                   </select>
                </div>

                <div>
                   <label className="block text-xs font-bold text-gray-500 mb-1">3. Ancho Disponible (cm)</label>
                   <div className="flex items-center gap-2">
                      <input 
                        type="number" 
                        value={calcWidth} 
                        onChange={(e) => setCalcWidth(parseFloat(e.target.value))}
                        className="w-full border border-indigo-300 rounded p-2 font-bold text-indigo-900" 
                      />
                      <Ruler size={16} className="text-gray-400"/>
                   </div>
                </div>
             </div>

             <div className="mt-4 bg-white p-4 rounded border border-indigo-100 flex flex-col md:flex-row justify-between items-center gap-4">
                <div className="text-sm text-gray-600">
                   <p>Para obtener <strong>{reqAreaCm2.toFixed(0)} cm²</strong> libres usando una rejilla al <strong>{(calcGrilleType * 100).toFixed(0)}%</strong>:</p>
                   <p className="mt-1">Necesitas romper un área física de: <strong>{calcPhysicalArea.toFixed(0)} cm²</strong></p>
                </div>
                <div className="text-right">
                   <p className="text-xs text-gray-500 uppercase font-bold">Altura de Corte Sugerida</p>
                   <p className="text-3xl font-black text-indigo-700">{calcRequiredHeight.toFixed(1)} cm</p>
                   <p className="text-xs text-gray-400"> (Ancho {calcWidth}cm x Alto {calcRequiredHeight.toFixed(1)}cm)</p>
                </div>
             </div>
          </section>

          {/* Section 6: Checklist Normativo */}
          <section className="border rounded-lg p-4 bg-white print:border-gray-300">
            <h3 className="font-bold text-lg mb-3 border-b pb-1 text-blue-800">5. Lista de Verificación (NTC 3631)</h3>
            <div className="grid grid-cols-1 gap-2">
               {checklistItems.map((item) => (
                 <div key={item.id} className="flex items-start gap-3 p-2 hover:bg-gray-50 rounded border-b last:border-0 border-gray-100">
                    <div className="flex flex-col gap-2 min-w-[120px]">
                      {/* Checkbox Cumple */}
                      <label className={`flex items-center gap-1 cursor-pointer select-none transition-opacity ${checklist[item.id] === 'na' ? 'opacity-30' : 'opacity-100'}`}>
                        <div 
                          onClick={() => handleChecklistChange(item.id, 'ok')}
                          className={`w-5 h-5 rounded border flex items-center justify-center transition-colors ${checklist[item.id] === 'ok' ? 'bg-green-600 border-green-600 text-white' : 'bg-white border-gray-300'}`}
                        >
                           {checklist[item.id] === 'ok' && <CheckCircle size={14} />}
                        </div>
                        <span className="text-xs font-bold text-gray-600">Cumple</span>
                      </label>

                      {/* Checkbox No Aplica */}
                      <label className="flex items-center gap-1 cursor-pointer select-none">
                        <div 
                          onClick={() => handleChecklistChange(item.id, 'na')}
                          className={`w-5 h-5 rounded border flex items-center justify-center transition-colors ${checklist[item.id] === 'na' ? 'bg-gray-500 border-gray-500 text-white' : 'bg-white border-gray-300'}`}
                        >
                           {checklist[item.id] === 'na' && <MinusCircle size={14} />}
                        </div>
                        <span className="text-xs font-bold text-gray-500">No aplica</span>
                      </label>
                    </div>
                    <span className="text-sm mt-1 text-gray-800 leading-tight py-1">{item.label}</span>
                 </div>
               ))}
            </div>
            <div className="mt-2 text-xs text-gray-400 text-right italic">
              * Marcar "Cumple" o "No aplica" para aprobar el punto.
            </div>
          </section>

          {/* Section 7: Dictamen Final */}
          <section className="border-2 border-gray-800 rounded-lg p-6 bg-white print:break-inside-avoid">
            <h3 className="font-bold text-xl mb-4 text-center uppercase tracking-wider">Dictamen de Inspección</h3>
            
            <div className="grid grid-cols-2 gap-8 mb-6">
              <div>
                 <p className="text-sm text-gray-500 mb-1">Resultado Volumen</p>
                 <div className={`text-lg font-bold flex items-center gap-2 ${meetsVolume ? 'text-green-600' : 'text-red-600'}`}>
                    {meetsVolume ? <CheckCircle /> : <XCircle />}
                    {meetsVolume ? 'Cumple por Volumen' : 'Insuficiente (Requiere Ventilación)'}
                 </div>
              </div>

              <div>
                 <p className="text-sm text-gray-500 mb-1">Resultado Aberturas</p>
                 <div className="text-sm space-y-1">
                   <div className="flex justify-between">
                     <span>Requerido ({ventMethod}):</span>
                     <span className="font-bold">{reqAreaCm2.toFixed(0)} cm²</span>
                   </div>
                   <div className="flex justify-between border-t pt-1">
                     <span>Instalado:</span>
                     <span className={`font-bold ${actualFreeArea >= reqAreaCm2 ? 'text-green-600' : 'text-red-600'}`}>{actualFreeArea.toFixed(0)} cm²</span>
                   </div>
                 </div>
              </div>
            </div>

            <div className={`p-4 rounded-lg text-center border-2 ${globalStatus ? 'border-green-600 bg-green-50' : 'border-red-600 bg-red-50'}`}>
              <h2 className={`text-3xl font-black uppercase ${globalStatus ? 'text-green-700' : 'text-red-700'}`}>
                {globalStatus ? 'APROBADO' : 'NO APROBADO'}
              </h2>
              <p className="text-sm mt-2 text-gray-700">
                {globalStatus 
                  ? 'El recinto cumple con los requisitos de ventilación de la NTC 3631.' 
                  : 'El recinto NO cumple con las condiciones mínimas de seguridad.'}
              </p>
            </div>

            <div className="mt-8 pt-8 border-t flex justify-between items-end print:mt-12">
               <div className="text-center w-64">
                 <div className="border-b border-black h-8 mb-2"></div>
                 <p className="text-sm font-bold">Firma Inspector</p>
               </div>
               <div className="text-center w-64">
                 <div className="border-b border-black h-8 mb-2"></div>
                 <p className="text-sm font-bold">Firma Usuario / Testigo</p>
               </div>
            </div>
          </section>

        </div>
      </div>

      {/* Modal Referencia Normativa */}
      {showModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 print:hidden">
          <div className="bg-white rounded-lg max-w-2xl w-full max-h-[80vh] overflow-y-auto p-6 relative">
            <button onClick={() => setShowModal(false)} className="absolute top-4 right-4 text-gray-500 hover:text-black">
              <XCircle size={24} />
            </button>
            <h2 className="text-xl font-bold mb-4 flex items-center gap-2">
               <Info className="text-blue-600" /> Referencia NTC 3631
            </h2>
            
            <div className="space-y-4 text-sm text-gray-700">
              <div className="p-3 bg-blue-50 rounded">
                <h4 className="font-bold text-blue-800">4.1.1 Método Estándar (Volumen)</h4>
                <p>El volumen mínimo requerido debe ser <strong>3.4 m³ por cada kW</strong> de potencia nominal agregada.</p>
              </div>

              <div className="p-3 bg-gray-50 rounded">
                <h4 className="font-bold text-gray-800">4.1.2 Aberturas (Espacios Interiores)</h4>
                <p>Dos aberturas (una superior a 180cm, una inferior a 30cm). Área libre mínima: Mayor entre <strong>645 cm²</strong> o <strong>22 cm²/kW</strong>.</p>
              </div>

              <div className="p-3 bg-gray-50 rounded">
                <h4 className="font-bold text-gray-800">4.2.1 Método 1 (Aire Exterior)</h4>
                <ul className="list-disc pl-5 mt-1">
                  <li><strong>Vertical/Directo:</strong> 6 cm²/kW por abertura.</li>
                  <li><strong>Horizontal:</strong> 11 cm²/kW por abertura.</li>
                </ul>
              </div>

              <div className="p-3 bg-yellow-50 rounded border border-yellow-200">
                <h4 className="font-bold text-yellow-800">Notas Importantes</h4>
                <ul className="list-disc pl-5 mt-1">
                  <li>La dimensión menor de cualquier abertura no debe ser inferior a 8 cm.</li>
                  <li>Si se usan rejillas, considerar el área libre real (el factor de obstrucción).</li>
                  <li>No se permite un solo ducto vertical para conectar aberturas superior e inferior.</li>
                </ul>
              </div>
            </div>

            <div className="mt-6 text-right">
              <button onClick={() => setShowModal(false)} className="px-4 py-2 bg-gray-800 text-white rounded">Cerrar</button>
            </div>
          </div>
        </div>
      )}
      
      <div className="text-center text-xs text-gray-400 mt-8 mb-4 print:hidden">
         Desarrollado para asistencia técnica NTC 3631. Verificar siempre la norma oficial vigente.
      </div>
    </div>
  );
};

export default App;